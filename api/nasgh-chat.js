return res.status(500).send("Missing GEMINI_API_KEY env var");
}

    // ูู ุงูุณุคุงู ุบูุฑ ุฒุฑุงุนู โ ุฑุฏ ุงุนุชุฐุงุฑ ุจุณูุท
    const guardPrompt = `
ุงูุณุคุงู ูู ุงููุฒุงุฑุน:
"${userMessage}"

ูุฑูุฑ ููุท ูู ุงูุณุคุงู ูุชุนูู ุจุงูุฒุฑุงุนุฉ ูุงูุชุฑุจุฉ ูุงููุจุงุชุงุช ูุงูุฑู ูุงูุชุณููุฏ ุฃู ูุง.
- ุงุฐุง ูุงู ูุชุนูููุง ุจุงูุฒุฑุงุนุฉ ุจุฃู ุดููุ ุฃุฌุจ ุจูููุฉ ูุงุญุฏุฉ: "AGRI"
- ุงุฐุง ูุงู ูุง ุนูุงูุฉ ูู ุจุงูุฒุฑุงุนุฉุ ุฃุฌุจ ุจูููุฉ ูุงุญุฏุฉ: "OTHER"
ูุง ุชูุชุจ ุฃู ุดูุก ุขุฎุฑ ุบูุฑ ูุฐู ุงููููุฉ.
`;

    // ===== ุฏุงูุฉ ุงุชุตุงู ุนุงูุฉ ูุน Gemini =====
async function callGemini(promptText, model) {
const payload = {
contents: [{ parts: [{ text: promptText }] }],
@@ -68,22 +58,31 @@ export default async function handler(req, res) {
return text.trim();
}

    // 1) ูุญุต ูู ุงูุณุคุงู ุฒุฑุงุนู ุฃู ูุง
    // ===== 1) ูุญุต ุฅุฐุง ุงูุณุคุงู ุฒุฑุงุนู ุฃู ูุง =====
    const guardPrompt = `
ุงูุณุคุงู ูู ุงููุฒุงุฑุน:
"${userMessage}"

ูุฑูุฑ ููุท ูู ุงูุณุคุงู ูุชุนูู ุจุงูุฒุฑุงุนุฉ ูุงูุชุฑุจุฉ ูุงููุจุงุชุงุช ูุงูุฑู ูุงูุชุณููุฏ ุฃู ูุง.
- ุงุฐุง ูุงู ูุชุนูููุง ุจุงูุฒุฑุงุนุฉ ุจุฃู ุดููุ ุฃุฌุจ ุจูููุฉ ูุงุญุฏุฉ: "AGRI"
- ุงุฐุง ูุงู ูุง ุนูุงูุฉ ูู ุจุงูุฒุฑุงุนุฉุ ุฃุฌุจ ุจูููุฉ ูุงุญุฏุฉ: "OTHER"
ูุง ุชูุชุจ ุฃู ุดูุก ุขุฎุฑ ุบูุฑ ูุฐู ุงููููุฉ.
`;

let classification = "AGRI";
try {
classification = await callGemini(guardPrompt, "gemini-2.0-flash");
} catch (e) {
      // ูู ูุดู ุงูุชุตูููุ ูููู ุนุงุฏู ููุนุชุจุฑู AGRI
      classification = "AGRI";
      classification = "AGRI"; // ูู ูุดู ุงูุชุตููู ูููู ูุฃูู ุฒุฑุงุนู
}

if (classification !== "AGRI") {
const safeReply =
        "ุญูุงู ุฃุฎููุ ูุฐุง ุงููุณุงุนุฏ ูุฎุตุต ูุฃุณุฆูุฉ ุงูุฒุฑุงุนุฉ ูุงูุชุฑุจุฉ ูุงูุฑู ูุงูุชุณููุฏ ููุท ๐ฑ. ุฅุฐุง ุนูุฏู ุณุคุงู ุนู ูุฒุฑุนุชู ุฃู ุชุฑุจุฉ ูุจุงุช ูุนูููุ ุงุทุฑุญู ูุจุณุงุนุฏู ุฅู ุดุงุก ุงููู.";
        "ุญูุงู ุฃุฎููุ ูุฐุง ุงููุณุงุนุฏ ูุฎุตุต ูุฃุณุฆูุฉ ุงูุฒุฑุงุนุฉ ูุงูุชุฑุจุฉ ูุงูุฑู ูุงูุชุณููุฏ ููุท ๐ฑ. ุฅุฐุง ุนูุฏู ุณุคุงู ุนู ูุฒุฑุนุชู ุฃู ุชุฑุจุฉ ูุจุงุช ูุนูููุ ุงุทุฑุญู ูุจุณุงุนุฏู ุนูู ูุฏ ูุง ุฃูุฏุฑ.";
return res.status(200).send(safeReply);
}

    // 2) ุจูุงุก ุจุฑููุจุช ุงูุฅุฌุงุจุฉ ุงูุฒุฑุงุนูุฉ ุจุฃุณููุจ ูุณุบ
    // ===== 2) ุจุฑููุจุช ุงูุฅุฌุงุจุฉ ุจุฃุณููุจ ูุณุบ ุงููุงุซู =====
const soilText = soil ? JSON.stringify(soil, null, 2) : "ูุง ุชูุฌุฏ ูุฑุงุกุงุช ุญุฏูุซุฉ";
const adviceText = lastAdvice || "ูุง ุชูุฌุฏ ุชูุตูุฉ ููุชูุจุฉ ุญุงููุงู.";

@@ -92,7 +91,7 @@ export default async function handler(req, res) {
ุงููุบุฉ ุงููุทููุจุฉ: ุนุฑุจูุฉ ุจุณูุทุฉ + ููุณุฉ ุฎูููุฉ ูู ุงูุนุงููุฉ ุงูุนูุงููุฉ ุจุฏูู ูุจุงูุบุฉ.

ุงููุนูููุงุช ุงููุชุงุญุฉ:
- ุขุฎุฑ ูุฑุงุกุงุช ูู ุฌูุงุฒ ูุณุบ ุฅู ูุฌุฏุช:
- ุขุฎุฑ ูุฑุงุกุงุช ูู ุฌูุงุฒ ูุณุบ ุฅู ูุฌุฏุช (ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉุ ุฑุทูุจุฉ ุงูุชุฑุจุฉุ ECุ pHุ NPKุ SHS ...):
${soilText}

- ุขุฎุฑ ุชูุตูุฉ ููุชูุจุฉ ูู ูุณุบ ุฅู ูุฌุฏุช:
@@ -101,16 +100,23 @@ ${adviceText}
- ุณุคุงู ุงููุฒุงุฑุน:
"${userMessage}"

ุงูุชุนูููุงุช:
- ุฌุงูุจ ุจุตูุบุฉ ูุญุชุฑูุฉ ููุฑูุจุฉ ูู ุงููุฒุงุฑุนุ ุงุณุชุฎุฏู ูููุงุช ูุซู "ุฃุฎูู"ุ "ุชูุฏุฑ"ุ "ุญุงูู"ุ ููู ุชุฌููุจ ูููุงุช ูุซู "ุญุจูุจู" ุฃู "ููุจู".
ุงูุชุนูููุงุช ูุฃุณููุจ ุงูุฑุฏ:
- ุฎุงุทุจ ุงููุฒุงุฑุน ุจูููุฉ "ุฃุฎูู" ุฃู "ุฃุฎู ุงููุฒุงุฑุน" ูู ุจุฏุงูุฉ ุงูุฌูุงุจ.
- ุฌุงูุจ ุจุตูุบุฉ ูุงุซูุฉุ ูุฃูู ุฎุจูุฑ ูุณุบ ูุนุชูุฏ ุชุนุชูุฏ ุนูู ูุฑุงุกุงุช ุงูุฌูุงุฒ.
- ูุง ุชุทูุจ ูู ุงููุฒุงุฑุน ุงุณุชุดุงุฑุฉ ูููุฏุณ ุฒุฑุงุนู ุฃู ุฎุจูุฑ ุฎุงุฑุฌูุ ููุง ุชุฐูุฑ ุนุจุงุฑุงุช ูุซู:
  (ุงุณุชุดุฑ ูุฎุชุตุ ุฑุงุฌุน ูููุฏุณ ุฒุฑุงุนูุ ุงูุฃูุถู ุชุณุฃู ุฎุจูุฑ).
- ุงุฑุจุท ุฅุฌุงุจุชู ูุฏุฑ ุงูุฅููุงู ุจูุฑุงุกุงุช ุงูุชุฑุจุฉ: ูุซูุงู ุฅุฐุง K ููุฎูุถ โ ุฑููุฒ ุนูู ุงูุจูุชุงุณูููุ ูููุฐุง.
- ุงุนุทู ุญููู ุนูููุฉ ูุจุงุดุฑุฉ: ููุน ุงูุณูุงุฏ (ูุซูุงู NPK 20-20-20ุ ุฃู ุณูุงุฏ ุนุงูู ุงูุจูุชุงุณููู)ุ
  ุฃู ุจุฏุงุฆู ุนุถููุฉ (ุณูุงุฏ ุนุถูู ูุชุญููุ ููุจูุณุชุ ุณูุงุฏ ุฏุฌุงุฌุ ุฑูุงุฏ ุฎุดุจุ ูุฎููุงุช ูุฎูู... ุฅูุฎ) ุญุณุจ ุงูุนูุตุฑ.
- ุฎูู ูุฎุชุตุฑ ููุงุถุญ ูุณูู ุงูููู (ูู 3 ุฅูู 6 ุฌูู ููุท).
- ุฃุฑุจุท ุฅุฌุงุจุชู ูุฏุฑ ุงูุฅููุงู ุจูุฑุงุกุงุช ุงูุชุฑุจุฉ ุฃู ุงูุชูุตูุฉ ุงูุณุงุจูุฉ ุฅุฐุง ูุงูุช ููุงุณุจุฉ ููุณุคุงู.
- ูู ุงููุฒุงุฑุน ูุณุฃู ุนู ูุนูู ูุฑุญูุฉ ููู ูุนููุฉ ุฃู ุดุฑุญ ุชูุตูุฉุ ุงุดุฑุญูุง ูู ุจูุบุฉ ุจุณูุทุฉ.
- ูุง ุชุฐูุฑ ุฃุณูุงุก ููุฏููุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู.
- ูุง ุชุฐูุฑ ุฅูู ูููุฐุฌ ูุบููุ ุฑููุฒ ุฃู ุงูููุงู ุตุงุฏุฑ ูู "ูุณุงุนุฏ ูุณุบ".
- ูุง ุชูุฑุฌุน ุฃู JSON ุฃู ุฃููุงุฏุ ุฃุฑุฌุน ูุต ุนุฑุจู ุทุจูุนู ููุท.

ุงุจุฏุฃ ุงูุฑุฏ ูุจุงุดุฑุฉ ุจุฏูู ููุฏูุฉ ุชูููุฉ.
- ุงุณุชุฎุฏู ุฌูู ูุซู:
  "ูู ูุฑุงุกุงุช ุฌูุงุฒ ูุณุบ ุฃูุง ุฃุดูู ุฃู..."ุ
  "ุฃูุถู ุดู ุชุณููู ุงูุญูู ูู..."ุ
  "ุญุงูู ุชุณูู ูุฐุง ููุฐุง ุฎูุงู ุงูุฃูุงู ุงูุฌุงูุฉ..."
- ูุง ุชุฐูุฑ ุฃุณูุงุก ููุฏููุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู ููุง ุชุดุฑุญ ููู ุชุดุชุบู.
- ูุง ุชูุฑุฌุน ุฃู JSON ุฃู ุชูุณูู ุจุฑูุฌูุ ุฃุฑุฌุน ูุต ุนุฑุจู ุทุจูุนู ููุท ุจุฏูู ุฃู ุญููู ุฅุถุงููุฉ.

ุงุจุฏุฃ ุงูุฑุฏ ูุจุงุดุฑุฉ ุจุฌููุฉ ุนุฑุจูุฉ ูููุฒุงุฑุน ุจุฏูู ุฃู ุดุฑุญ ุชููู.
`;

const MODELS = [
@@ -123,8 +129,7 @@ ${adviceText}
for (const model of MODELS) {
try {
const reply = await callGemini(mainPrompt, model);
        // ูุฑุฌูุน ุงููุต ููุท ุจุฏูู JSON
        return res.status(200).send(reply);
        return res.status(200).send(reply); // ูุฑุฌูุน ุงููุต ููุท
} catch (err) {
lastError = err.message;
continue;
