<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ù‚Ø±Ø§Ø¡Ø§Øª Ù†ÙØ³Øº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Ù„Ùˆ ÙØªØ­ØªÙ‡ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù…Ù† Ù…Ù„ÙØŒ Ø­ÙˆÙ‘Ù„Ù‡ Ø¥Ø¬Ø¨Ø§Ø±ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Vercel -->
  <script>
    if (location.protocol === "file:") {
      window.location.href = "https://nasgh.vercel.app";
    }
  </script>

  <style>
    :root {
      --nasgh-green: #4caf50;
      --nasgh-dark-green: #135a3b;
      --nasgh-yellow: #f1c232;
      --bg-light: #f5fff7;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, #eafff3, #f4fff9 40%, #ffffff 100%);
      margin: 0;
      padding: 12px;
      color: #123322;
    }

    .page {
      max-width: 980px;
      margin: 0 auto 80px auto; /* Ù…Ø³Ø§Ø­Ø© Ù„Ø²Ø± Ø§Ù„Ø´Ø§Øª */
    }

    /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù…Ø¹ Ø§Ù„Ù„ÙˆØ¬Ùˆ */
    .topbar {
      background: #ffffff;
      border-radius: 18px;
      padding: 10px 18px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
      border: 1px solid #e0f2e9;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-img {
      width: 42px;
      height: auto;
    }

    .logo-text-main {
      font-weight: 700;
      font-size: 18px;
      color: var(--nasgh-dark-green);
      letter-spacing: 0.08em;
    }

    .logo-text-sub {
      font-size: 12px;
      color: #4a4a4a;
    }

    .topbar-right {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .topbar-right a {
      text-decoration: none;
      font-size: 13px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid #c8e6c9;
      color: var(--nasgh-dark-green);
      background: #f5fff7;
      transition: 0.12s;
      white-space: nowrap;
    }

    .topbar-right a:hover {
      background: linear-gradient(135deg, var(--nasgh-green), var(--nasgh-yellow));
      color: #ffffff;
      border-color: transparent;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
      padding: 14px 16px 18px;
      margin-bottom: 14px;
      border: 1px solid #e0f2e9;
    }

    h1 {
      font-size: 20px;
      margin-top: 0;
      margin-bottom: 6px;
      text-align: center;
      color: var(--nasgh-dark-green);
    }

    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #4f6f5d;
      margin-bottom: 12px;
    }

    #status {
      font-size: 13px;
      margin-bottom: 10px;
      padding: 7px 9px;
      border-radius: 10px;
      background: #e8f5e9;
      border: 1px solid #c8e6c9;
    }

    .error {
      background: #ffebee !important;
      border-color: #ffcdd2 !important;
      color: #b71c1c;
    }

    .btn {
      display: inline-block;
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--nasgh-green), var(--nasgh-yellow));
      color: #ffffff;
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.12s;
      box-shadow: 0 6px 16px rgba(19, 90, 59, 0.25);
    }

    .btn.secondary {
      background: #00695c;
      box-shadow: 0 6px 16px rgba(0, 105, 92, 0.25);
      margin-right: 6px;
    }

    .btn.ai {
      background: #1565c0;
      box-shadow: 0 6px 16px rgba(21, 101, 192, 0.25);
      margin-top: 4px;
    }

    .btn:active {
      transform: scale(0.98);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
    }

    .btn:disabled {
      background: #a5d6a7;
      box-shadow: none;
      cursor: default;
      transform: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 13px;
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 5px 3px;
      text-align: center;
    }

    th {
      background: #e0f2f1;
      font-weight: 600;
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    .reading-id {
      font-size: 12px;
      color: #607d8b;
      margin-bottom: 3px;
    }

    .time {
      font-size: 11px;
      color: #90a4ae;
      text-align: left;
    }

    .ai-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #1b5e20;
    }

    .ai-status {
      font-size: 12px;
      margin-bottom: 3px;
      color: #455a64;
    }

    .ai-box {
      margin-top: 6px;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid #cfd8dc;
      background: #fafafa;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    /* ===== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù†Ø¨Ø§Øª + Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ø§Ø±Ø§Øª ===== */
    .plant-form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 6px;
    }

    .plant-form label {
      font-size: 12px;
      color: #455a64;
    }

    .plant-form input,
    .plant-form select {
      padding: 7px 8px;
      border-radius: 10px;
      border: 1px solid #cfd8dc;
      font-size: 13px;
      outline: none;
      background: #f9fffb;
    }

    .plant-form input:focus,
    .plant-form select:focus {
      border-color: var(--nasgh-green);
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.18);
      background: #ffffff;
    }

    .targets-table {
      margin-top: 6px;
    }

    .bar-wrapper {
      width: 100%;
      height: 12px;
      border-radius: 999px;
      background: #eceff1;
      overflow: hidden;
      margin-bottom: 3px;
    }

    .bar-fill {
      height: 100%;
      width: 40%;
    }

    .bar-low {
      background: #e53935;   /* Ø£Ø­Ù…Ø± */
    }

    .bar-ok {
      background: #43a047;   /* Ø£Ø®Ø¶Ø± */
    }

    .bar-high {
      background: #8e24aa;   /* Ø¨Ù†ÙØ³Ø¬ÙŠ */
    }

    .legend {
      margin-top: 6px;
      font-size: 11px;
      color: #455a64;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .legend-box {
      width: 14px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
      margin-left: 3px;
    }

    .legend-box.low { background: #e53935; }
    .legend-box.ok  { background: #43a047; }
    .legend-box.high{ background: #8e24aa; }

    @media (max-width: 600px) {
      body {
        padding: 8px;
      }
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .topbar-right {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }
      .btn {
        width: auto;
      }
    }

    /* ===== Ø´Ø§Øª Ø¨ÙˆØª Ù†Ø³Øº ===== */
    .chat-fab {
      position: fixed;
      left: 18px;
      bottom: 20px;
      background: linear-gradient(135deg, var(--nasgh-green), var(--nasgh-yellow));
      color: #ffffff;
      border-radius: 999px;
      padding: 10px 18px;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      border: none;
      font-size: 14px;
      cursor: pointer;
      z-index: 40;
    }

    .chat-fab span.icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2e7d32;
      font-size: 14px;
    }

    .chat-panel {
      position: fixed;
      left: 8px;
      right: 8px;
      bottom: 70px;
      max-width: 480px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.35);
      border: 1px solid #c8e6c9;
      display: none;
      flex-direction: column;
      max-height: 70vh;
      z-index: 50;
    }

    .chat-header {
      padding: 10px 12px;
      border-bottom: 1px solid #e0f2e9;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f5fff7;
      border-radius: 18px 18px 0 0;
    }

    .chat-header-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chat-header-title .name {
      font-size: 14px;
      font-weight: 600;
      color: var(--nasgh-dark-green);
    }

    .chat-header-title .hint {
      font-size: 11px;
      color: #607d8b;
    }

    .chat-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: #607d8b;
    }

    .chat-messages {
      padding: 10px 12px;
      overflow-y: auto;
      flex: 1;
      background: #ffffff;
    }

    .chat-bubble {
      max-width: 90%;
      padding: 8px 10px;
      border-radius: 12px;
      margin-bottom: 6px;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .from-user {
      margin-left: auto;
      background: #e8f5e9;
      border-radius: 12px 0 12px 12px;
    }

    .from-bot {
      margin-right: auto;
      background: #f1f8e9;
      border-radius: 0 12px 12px 12px;
    }

    .chat-input-row {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px 10px;
      border-top: 1px solid #e0f2e9;
      background: #ffffff;
      border-radius: 0 0 18px 18px;
    }

    .chat-input-row textarea {
      flex: 1;
      resize: none;
      border-radius: 12px;
      border: 1px solid #cfd8dc;
      padding: 7px 8px;
      font-size: 13px;
      min-height: 34px;
      max-height: 80px;
    }

    .chat-input-row button {
      border-radius: 999px;
      border: none;
      background: var(--nasgh-green);
      color: white;
      padding: 7px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    .chat-input-row button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    /* ØªÙƒØ¨ÙŠØ± Ø¹Ø±Ø¶ Ø®Ø§Ù†Ø© "Ø§Ù„Ø­Ø§Ù„Ø©" ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø£ÙØ¶Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª */
    #targetsTable th:nth-child(4),
    #targetsTable td:nth-child(4) {
      width: 120px !important;
      min-width: 120px !important;
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù…Ø¹ Ø§Ù„Ù„ÙˆØ¬Ùˆ -->
    <header class="topbar">
      <div class="topbar-left">
        <img src="images/nasgh-logo.png" alt="NASGH logo" class="logo-img" />
        <div>
          <div class="logo-text-main">NASGH Ù†Ø³Øº</div>
          <div class="logo-text-sub">Ù‚Ø±Ø§Ø¡Ø© Ø¯Ù‚ÙŠÙ‚Ø©â€¦ ØªÙˆØµÙŠØ© Ø°ÙƒÙŠØ©â€¦ Ù…Ø­ØµÙˆÙ„ Ø£ÙØ¶Ù„.</div>
        </div>
      </div>
      <div class="topbar-right">
        <a href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</a>
        <a href="login.html"> ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</a>
      </div>
    </header>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª -->
    <div class="card">
      <h1>Ù„ÙˆØ­Ø© Ù‚Ø±Ø§Ø¡Ø§Øª Ù†ÙØ³Øº</h1>
      <div class="subtitle">Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Ø¹ØµØ§ Ù†ÙØ³Øº  </div>

      <div id="status">Ø§Ù„Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù…ØªØµÙ„</div>

      <button id="connectBtn" class="btn">Ø§ØªØµØ§Ù„ Ø¨Ø¹ØµØ§ Ù†ÙØ³Øº</button>
      <button id="disconnectBtn" class="btn secondary" disabled>Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„</button>

      <div class="reading-id" id="readingMeta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ø¨Ø¹Ø¯</div>
      <div class="time" id="timeLabel"></div>

      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ù‚ÙŠØ§Ø³</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©</td>
            <td id="tValue">-- Â°Ù…</td>
          </tr>
          <tr>
            <td>Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø©</td>
            <td id="mValue">-- Ùª</td>
          </tr>
          <tr>
            <td>Ø§Ù„Ù…Ù„ÙˆØ­Ø© (EC)</td>
            <td id="ecValue">-- ÂµS/cm</td>
          </tr>
          <tr>
            <td>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ù…ÙˆØ¶Ø© (pH)</td>
            <td id="phValue">-- pH</td>
          </tr>
          <tr>
            <td>Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ† (N)</td>
            <td id="nValue">-- mg/kg</td>
          </tr>
          <tr>
            <td>Ø§Ù„ÙÙˆØ³ÙÙˆØ± (P)</td>
            <td id="pValue">-- mg/kg</td>
          </tr>
          <tr>
            <td>Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… (K)</td>
            <td id="kValue">-- mg/kg</td>
          </tr>
          <tr>
            <td>Ù…Ø¤Ø´Ø± Ø§Ù„Ù‡ÙŠÙˆÙ…ÙŠÙƒ Ø£Ø³ÙŠØ¯</td>
            <td id="humValue">--</td>
          </tr>
          <tr>
            <td>Ù…Ø¤Ø´Ø± ØµØ­Ø© Ø§Ù„ØªØ±Ø¨Ø© (SHS)</td>
            <td id="shsValue">--</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¨Ø§Øª ÙˆØ£ÙØ¶Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª -->
    <div class="card">
      <div class="ai-title">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¨Ø§Øª ÙˆØ£ÙØ¶Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</div>
      <div class="ai-status">
        Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ù†Ø¨Ø§Øª ÙˆØ§Ø®ØªØ± Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ ÙˆÙ†Ø³Øº AI Ø¨ÙŠØ­Ø³Ø¨ Ù„Ùƒ Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ù„ÙƒÙ„ Ø¹Ù†ØµØ± ÙˆÙŠÙ‚Ø§Ø±Ù†Ù‡ Ø¨Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø¹ØµØ§ Ù†ÙØ³Øº.
      </div>

      <div class="plant-form">
        <label for="plantNameInput">Ù†ÙˆØ¹ Ø§Ù„Ù†Ø¨Ø§Øª</label>
        <input id="plantNameInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø·Ù…Ø§Ø·Ù…ØŒ Ø®ÙŠØ§Ø±ØŒ Ù„ÙŠÙ…ÙˆÙ†..." />

        <label for="plantStageSelect">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
        <select id="plantStageSelect">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</option>
          <option value="vegetative">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ø®Ø¶Ø±ÙŠ</option>
          <option value="flowering">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø²Ù‡Ø§Ø±</option>
          <option value="fruit-setting">Ù…Ø±Ø­Ù„Ø© Ø¹Ù‚Ø¯ Ø§Ù„Ø«Ù…Ø§Ø±</option>
          <option value="harvest">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø«Ù…Ø§Ø± / Ø§Ù„Ø­ØµØ§Ø¯</option>
        </select>

        <button id="targetsBtn" class="btn ai" type="button">Ø­Ø³Ø§Ø¨ Ø£ÙØ¶Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</button>
      </div>

      <div id="targetsStatus" class="ai-status"></div>

      <table id="targetsTable" class="targets-table">
        <thead>
          <tr>
            <th>Ø§Ù„Ø¹Ù†ØµØ±</th>
            <th>Ù‚Ø±Ø§Ø¡Ø© Ø¹ØµØ§ Ù†ÙØ³Øº</th>
            <th>Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          </tr>
        </thead>
        <tbody id="targetsTableBody">
          <!-- ÙŠÙ…ØªÙ„Ø¦ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </tbody>
      </table>

      <div class="legend">
        <span class="legend-box low"></span> Ù†Ù‚Øµ
        <span class="legend-box ok"></span> Ù…Ù†Ø§Ø³Ø¨
        <span class="legend-box high"></span> Ø²ÙŠØ§Ø¯Ø©
      </div>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø© ØªÙˆØµÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ -->
    <div class="card">
      <div class="ai-title">ØªÙˆØµÙŠØ© Ù†ÙØ³Øº Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
      <div class="ai-status" id="aiStatus">Ù„Ù… ÙŠØªÙ… Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠØ© Ø¨Ø¹Ø¯.</div>
      <button id="aiBtn" class="btn ai">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª ÙˆØ¥Ø¹Ø·Ø§Ø¡ ØªÙˆØµÙŠØ©</button>
      <div class="ai-box" id="aiAdvice">
        Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…ØªÙˆÙØ±Ø© ÙˆØªØ­Ù„ÙŠÙ„Ù‡Ø§ Ù„Ø¥Ø®Ø±Ø§Ø¬ ØªÙˆØµÙŠØ© Ø±ÙŠ ÙˆØªØ³Ù…ÙŠØ¯ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
      </div>

      <button id="saveSessionBtn" class="btn" style="margin-top: 10px;">
        Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
      </button>
      <div class="ai-status" id="saveStatus"></div>
    </div>
  </div>

  <!-- ğŸ”’ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Auth -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCPCDnSjazRrxAZ1uVuwlvK5lBUYfmx4Io",
      authDomain: "nasgh1.firebaseapp.com",
      projectId: "nasgh1",
      storageBucket: "nasgh1.firebasestorage.app",
      messagingSenderId: "37730120812",
      appId: "1:37730120812:web:995e4f7d60cced8a709449",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ â†’ ÙŠØ±Ø¬Ø¹ Ù„ØµÙØ­Ø© Ø§Ù„Ù„ÙˆØ¬Ù†
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
      }
    });
  </script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« + AI + Ø´Ø§Øª Ø¨ÙˆØª -->
  <script>
    // ================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª BLE (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„ÙƒÙˆØ¯ ESP32) ==================
    const SERVICE_UUID        = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
    const CHARACTERISTIC_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

    let device = null;
    let characteristic = null;
    let lastData = null;          // Ø¢Ø®Ø± JSON Ù…Ù† Ø§Ù„Ø¹ØµØ§
    let lastTargets = null;       // Ø¢Ø®Ø± Ù…Ø¯Ù‰ Ù…Ø«Ø§Ù„ÙŠ Ù…Ù† /api/nasgh-targets
    let lastStatusSummary = null; // Ù…Ù„Ø®Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± (Ù†Ù‚Øµ/Ù…Ù†Ø§Ø³Ø¨/Ø²ÙŠØ§Ø¯Ø©)
    let lastAdviceText = "";      // Ø¢Ø®Ø± ØªÙˆØµÙŠØ©

    const statusEl   = document.getElementById("status");
    const connectBtn = document.getElementById("connectBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");

    const readingMetaEl = document.getElementById("readingMeta");
    const timeLabelEl   = document.getElementById("timeLabel");

    const aiStatusEl = document.getElementById("aiStatus");
    const aiAdviceEl = document.getElementById("aiAdvice");
    const aiBtn      = document.getElementById("aiBtn");
    const saveSessionBtn = document.getElementById("saveSessionBtn");
    const saveStatusEl   = document.getElementById("saveStatus");

    // Ø¹Ù†Ø§ØµØ± Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¨Ø§Øª ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„
    const plantNameInput = document.getElementById("plantNameInput");
    const plantStageSelect = document.getElementById("plantStageSelect");
    const targetsBtn = document.getElementById("targetsBtn");
    const targetsStatusEl = document.getElementById("targetsStatus");
    const targetsTableBody = document.getElementById("targetsTableBody");

    // API URLs
    const CLOUD_API_URL   = "/api/soil-data";      // Ù„Ø­ÙØ¸ Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø©
    const AI_API_URL      = "/api/nasgh-ai";       // ØªÙˆØµÙŠØ© AI
    const TARGETS_API_URL = "/api/nasgh-targets";  // Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ
    const CHAT_API_URL    = "/api/nasgh-chat";     // Ø´Ø§Øª Ø¨ÙˆØª
    const SESSION_API_URL = "/api/soil-session";   // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯

    function setStatus(text, isError = false) {
      statusEl.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: " + text;
      statusEl.classList.toggle("error", isError);
    }

    function formatTime(d) {
      return d.toLocaleTimeString("ar", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
      });
    }

    // Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ÙŠØ³ (POST)
    async function saveReadingToCloud(data) {
      try {
        await fetch(CLOUD_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            source: "ble-stick",
            reading: data,
          }),
        });
      } catch (err) {
        console.warn("Failed to save reading to cloud:", err);
      }
    }

    function applyReading(data, sourceLabel = "Ø¹ØµØ§ Ù†ÙØ³Øº") {
      if (!data) return;
      lastData = data;

      const now = new Date();
      readingMetaEl.textContent = "Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ù†: " + (data.id || sourceLabel);
      timeLabelEl.textContent   = "Ø§Ù„ÙˆÙ‚Øª: " + formatTime(now);

      if (typeof data.t !== "undefined") {
        document.getElementById("tValue").textContent =
          Number(data.t).toFixed(1) + " Â°Ù…";
      }

      if (typeof data.m !== "undefined") {
        document.getElementById("mValue").textContent =
          Number(data.m).toFixed(1) + " Ùª";
      }

      if (typeof data.ec !== "undefined") {
        document.getElementById("ecValue").textContent =
          Number(data.ec).toFixed(0) + " ÂµS/cm";
      }

      if (typeof data.ph !== "undefined") {
        document.getElementById("phValue").textContent =
          Number(data.ph).toFixed(2) + " pH";
      }

      if (typeof data.n !== "undefined") {
        document.getElementById("nValue").textContent =
          Number(data.n).toFixed(0) + " mg/kg";
      }

      if (typeof data.p !== "undefined") {
        document.getElementById("pValue").textContent =
          Number(data.p).toFixed(0) + " mg/kg";
      }

      if (typeof data.k !== "undefined") {
        document.getElementById("kValue").textContent =
          Number(data.k).toFixed(0) + " mg/kg";
      }

      if (typeof data.hum !== "undefined") {
        document.getElementById("humValue").textContent =
          Number(data.hum).toFixed(1);
      }

      if (typeof data.shs !== "undefined") {
        document.getElementById("shsValue").textContent =
          Number(data.shs).toFixed(1);
      }

      // Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ÙŠØ³
      saveReadingToCloud(data);
    }

    async function connect() {
      if (!navigator.bluetooth) {
        setStatus("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Web Bluetooth", true);
        alert("Web Bluetooth ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ø¬Ø±Ø¨ Google Chrome Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ø£Ùˆ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ØŒ Ø£Ùˆ Bluefy Ø¹Ù„Ù‰ iOS.");
        return;
      }

      try {
        setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹ØµØ§ Ù†ÙØ³Øº...");
        connectBtn.disabled = true;

        device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }],
          optionalServices: [SERVICE_UUID]
        });

        device.addEventListener("gattserverdisconnected", onDisconnected);

        setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²...");
        const server = await device.gatt.connect();

        const service = await server.getPrimaryService(SERVICE_UUID);
        characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

        await characteristic.startNotifications();
        characteristic.addEventListener("characteristicvaluechanged", handleNotification);

        setStatus("Ù…ØªØµÙ„ Ø¨Ø¹ØµØ§ Ù†ÙØ³Øº Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        disconnectBtn.disabled = false;

      } catch (err) {
        console.error(err);
        setStatus("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + err.message, true);
        connectBtn.disabled = false;
      }
    }

    function onDisconnected() {
      setStatus("ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹ØµØ§ Ù†ÙØ³Øº");
      disconnectBtn.disabled = true;
      connectBtn.disabled = false;
    }

    async function disconnect() {
      if (!device) return;
      try {
        await device.gatt.disconnect();
      } catch (e) {
        console.error(e);
      } finally {
        onDisconnected();
      }
    }

    function handleNotification(event) {
      const value = event.target.value;
      const decoder = new TextDecoder("utf-8");
      const text = decoder.decode(value);

      console.log("RAW BLE text:", text);

      try {
        const data = JSON.parse(text);
        applyReading(data, "Ø¹ØµØ§ Ù†ÙØ³Øº (BLE)");
      } catch (e) {
        console.error("JSON parse error:", e);
        setStatus("ÙˆÙØ¬Ø¯Øª Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ«", true);
      }
    }

    connectBtn.addEventListener("click", connect);
    disconnectBtn.addEventListener("click", disconnect);

    // ============ AI Ù„Ù„ØªÙˆØµÙŠØ© Ø§Ù„Ù†ØµÙŠØ© ============
    async function callAI() {
      if (!lastData) {
        aiStatusEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ø­Ø¯ÙŠØ«Ø© Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø¹ØµØ§ Ù†ÙØ³Øº Ø£ÙˆÙ„Ø§Ù‹.";
        return;
      }

      aiBtn.disabled = true;
      aiStatusEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„Ù‡Ø§...";
      aiAdviceEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ...";

      try {
        const payload = {
          soil: {
            id:   lastData.id || "NASGH-1",
            temp: lastData.t,
            moisture: lastData.m,
            ec:   lastData.ec,
            ph:   lastData.ph,
            n:    lastData.n,
            p:    lastData.p,
            k:    lastData.k,
            shs:  lastData.shs,
            humic: lastData.hum
          },
          language: "ar",
          plantName: plantNameInput.value.trim() || null,
          stage: plantStageSelect.value || null,
          targets: lastTargets || null,
          statusSummary: lastStatusSummary || null
        };

        const res = await fetch(AI_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const adviceText = await res.text();

        aiStatusEl.textContent = "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªÙˆØµÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…";
        aiAdviceEl.textContent = adviceText;
        lastAdviceText = adviceText;

      } catch (err) {
        console.error(err);
        aiStatusEl.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠØ©.";
        aiAdviceEl.textContent = "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.\n\nØ§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ù†ÙŠØ©: " + err.message;
      } finally {
        aiBtn.disabled = false;
      }
    }

    aiBtn.addEventListener("click", callAI);

    // ============ AI Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ + Ø§Ù„Ø¨Ø§Ø±Ø§Øª ============
    const PARAM_CONFIG = [
      { key: "temp",     field: "t",   label: "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©", unit: "Â°Ù…" },
      { key: "moisture", field: "m",   label: "Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø©", unit: "%" },
      { key: "ec",       field: "ec",  label: "Ø§Ù„Ù…Ù„ÙˆØ­Ø© EC",   unit: "ÂµS/cm" },
      { key: "ph",       field: "ph",  label: "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ù…ÙˆØ¶Ø© pH", unit: "" },
      { key: "n",        field: "n",   label: "Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ† (N)", unit: "mg/kg" },
      { key: "p",        field: "p",   label: "Ø§Ù„ÙÙˆØ³ÙÙˆØ± (P)", unit: "mg/kg" },
      { key: "k",        field: "k",   label: "Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… (K)", unit: "mg/kg" },
      { key: "shs",      field: "shs", label: "Ù…Ø¤Ø´Ø± ØµØ­Ø© Ø§Ù„ØªØ±Ø¨Ø© SHS", unit: "" },
      { key: "humic",    field: "hum", label: "Ù…Ø¤Ø´Ø± Ø§Ù„Ù‡ÙŠÙˆÙ…ÙŠÙƒ Ø£Ø³ÙŠØ¯", unit: "" }
    ];

    function clearTargetsTable() {
      targetsTableBody.innerHTML = "";
    }

    function buildTargetsTable(targets) {
      clearTargetsTable();
      lastTargets = targets || null;
      lastStatusSummary = {};

      if (!lastData) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø¹ØµØ§ Ù†ÙØ³Øº Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
        tr.appendChild(td);
        targetsTableBody.appendChild(tr);
        return;
      }

      PARAM_CONFIG.forEach((p) => {
        const cfg = targets && targets[p.key];
        const valueRaw = lastData[p.field];
        const value = typeof valueRaw === "number" ? valueRaw : Number(valueRaw);

        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = p.label;
        tr.appendChild(nameTd);

        const valueTd = document.createElement("td");
        if (isNaN(value)) {
          valueTd.textContent = "--";
        } else {
          valueTd.textContent =
            value.toFixed(p.key === "ph" ? 2 : (p.key === "temp" ? 1 : 0)) +
            (p.unit ? " " + p.unit : "");
        }
        tr.appendChild(valueTd);

        const rangeTd = document.createElement("td");
        let min = null, max = null;
        if (cfg && typeof cfg.min === "number" && typeof cfg.max === "number") {
          min = cfg.min;
          max = cfg.max;
          rangeTd.textContent =
            min.toFixed(p.key === "ph" ? 2 : 0) +
            " - " +
            max.toFixed(p.key === "ph" ? 2 : 0) +
            (p.unit ? " " + p.unit : "");
        } else {
          rangeTd.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯Ù‰ Ù…Ø­Ø¯Ø¯";
        }
        tr.appendChild(rangeTd);

        const statusTd = document.createElement("td");

        const wrapper = document.createElement("div");
        wrapper.className = "bar-wrapper";

        const bar = document.createElement("div");
        let statusText = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        let statusClass = "";
        let percent = 40;

        if (!isNaN(value) && min !== null && max !== null && max > min) {
          if (value < min) {
            statusText = "Ù†Ù‚Øµ";
            statusClass = "bar-low";
          } else if (value > max) {
            statusText = "Ø²ÙŠØ§Ø¯Ø©";
            statusClass = "bar-high";
          } else {
            statusText = "Ù…Ù†Ø§Ø³Ø¨";
            statusClass = "bar-ok";
          }

          const mid = (min + max) / 2;
          if (mid > 0) {
            percent = Math.min(100, Math.max(10, (value / mid) * 50));
          }
        }

        bar.className = "bar-fill " + statusClass;
        bar.style.width = percent + "%";

        wrapper.appendChild(bar);
        statusTd.appendChild(wrapper);

        const labelDiv = document.createElement("div");
        labelDiv.style.fontSize = "11px";
        labelDiv.textContent = statusText;
        statusTd.appendChild(labelDiv);

        tr.appendChild(statusTd);
        targetsTableBody.appendChild(tr);

        // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø®Øµ Ø¹Ø´Ø§Ù† AI ÙŠØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ø­Ø§Ù„Ø©
        lastStatusSummary[p.key] = {
          label: p.label,
          value: isNaN(value) ? null : value,
          unit: p.unit,
          min: min,
          max: max,
          status: statusText
        };
      });
    }

    async function callTargetsAI() {
      if (!lastData) {
        targetsStatusEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ø­Ø¯ÙŠØ«Ø© Ù…Ù† Ø¹ØµØ§ Ù†ÙØ³Øº. Ø®Ø° Ù‚Ø±Ø§Ø¡Ø© Ø£ÙˆÙ„Ø§Ù‹.";
        return;
      }

      const plantName = plantNameInput.value.trim();
      const stage = plantStageSelect.value;

      if (!plantName || !stage) {
        targetsStatusEl.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†ÙˆØ¹ Ø§Ù„Ù†Ø¨Ø§Øª ÙˆØ§Ø®ØªÙŠØ§Ø± Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ù…Ùˆ.";
        return;
      }

      targetsBtn.disabled = true;
      targetsStatusEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø£ÙØ¶Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù†Ø¨Ø§Øª ÙˆÙ…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ù…Ùˆ...";
      clearTargetsTable();

      try {
        const payload = {
          plantName,
          stage,
          soil: lastData
        };

        const res = await fetch(TARGETS_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const data = await res.json();
        buildTargetsTable(data.targets || {});
        targetsStatusEl.textContent = "ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ù„ÙƒÙ„ Ø¹Ù†ØµØ± âœ…";
      } catch (err) {
        console.error(err);
        targetsStatusEl.textContent = "ØµØ§Ø± Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.";
      } finally {
        targetsBtn.disabled = false;
      }
    }

    targetsBtn.addEventListener("click", callTargetsAI);

    // ============ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ============
    async function saveSession() {
      if (!lastData) {
        saveStatusEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ù„Ø­ÙØ¸Ù‡Ø§.";
        return;
      }
      if (!lastTargets || !lastStatusSummary) {
        saveStatusEl.textContent = "Ø§Ø­Ø³Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.";
        return;
      }
      if (!lastAdviceText) {
        saveStatusEl.textContent = "Ø§Ø·Ù„Ø¨ ØªÙˆØµÙŠØ© AI Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.";
        return;
      }

      saveSessionBtn.disabled = true;
      saveStatusEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯...";

      try {
        const payload = {
          soil: lastData,
          plantName: plantNameInput.value.trim() || null,
          stage: plantStageSelect.value || null,
          targets: lastTargets,
          statusSummary: lastStatusSummary,
          advice: lastAdviceText,
          timestamp: new Date().toISOString()
        };

        const res = await fetch(SESSION_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        saveStatusEl.textContent = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…";
      } catch (err) {
        console.error(err);
        saveStatusEl.textContent = "ØµØ§Ø± Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.";
      } finally {
        saveSessionBtn.disabled = false;
      }
    }

    saveSessionBtn.addEventListener("click", saveSession);

    // ================== Ø´Ø§Øª Ø¨ÙˆØª Ù†Ø³Øº ==================
    const chatFab = document.createElement("button");
    chatFab.className = "chat-fab";
    chatFab.innerHTML = '<span class="icon">ğŸ’¬</span><span>Ù†Ø³Øº AI</span>';

    const chatPanel = document.createElement("div");
    chatPanel.className = "chat-panel";
    chatPanel.innerHTML = `
      <div class="chat-header">
        <div class="chat-header-title">
          <span class="name">Ù…Ø³Ø§Ø¹Ø¯ Ù†Ø³Øº</span>
          <span class="hint">Ø§Ø³Ø£Ù„ Ø¹Ù† Ø§Ù„ØªÙˆØµÙŠØ© Ø£Ùˆ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±Ø¨Ø©</span>
        </div>
        <button class="chat-close" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-bubble from-bot">
          Ø­ÙŠØ§Ùƒ Ø£Ø®ÙˆÙŠ ğŸŒ±ØŒ Ù‡Ø°Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ù†Ø³Øº. Ø¥Ø°Ø§ Ù…Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØªÙˆØµÙŠØ© ÙˆØ§Ø¶Ø­Ø© Ù„Ùƒ Ø£Ùˆ Ø­Ø§Ø¨ ØªØ¹Ø±Ù Ø£ÙƒØ«Ø± Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±Ø¨Ø©ØŒ Ø§Ø³Ø£Ù„Ù†ÙŠ ÙˆØ¨Ø´Ø±Ø­ Ù„Ùƒ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø¨Ø³ÙŠØ·.
        </div>
      </div>
      <div class="chat-input-row">
        <textarea id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§ Ø¹Ù† Ø§Ù„ØªÙˆØµÙŠØ© Ø£Ùˆ Ø§Ù„ØªØ±Ø¨Ø©..."></textarea>
        <button id="chatSend">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    `;

    document.body.appendChild(chatFab);
    document.body.appendChild(chatPanel);

    const chatMessages = chatPanel.querySelector("#chatMessages");
    const chatInput = chatPanel.querySelector("#chatInput");
    const chatSend = chatPanel.querySelector("#chatSend");
    const chatCloseBtn = chatPanel.querySelector(".chat-close");

    chatFab.addEventListener("click", () => {
      chatPanel.style.display = "flex";
      chatPanel.style.bottom = "70px";
      chatInput.focus();
    });

    chatCloseBtn.addEventListener("click", () => {
      chatPanel.style.display = "none";
    });

    function addMessage(text, fromBot = false) {
      const div = document.createElement("div");
      div.className = "chat-bubble " + (fromBot ? "from-bot" : "from-user");
      div.textContent = text;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendChatMessage() {
      const text = chatInput.value.trim();
      if (!text) return;

      addMessage(text, false);
      chatInput.value = "";
      chatInput.focus();

      chatSend.disabled = true;
      addMessage("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ± ÙÙŠ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù†Ø§Ø³Ø¨Ø©...", true);

      try {
        const payload = {
          message: text,
          soil: lastData || null,
          lastAdvice: lastAdviceText || aiAdviceEl.textContent || ""
        };

        const res = await fetch(CHAT_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const data = await res.text();
        const thinking = chatMessages.querySelector(".from-bot:last-child");
        if (thinking) thinking.remove();

        addMessage(data, true);
      } catch (err) {
        console.error(err);
        const thinking = chatMessages.querySelector(".from-bot:last-child");
        if (thinking) thinking.remove();
        addMessage("ØµØ§Ø± Ø®Ø·Ø£ Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ø¨Ø¹Ø¯ Ø´ÙˆÙŠ.", true);
      } finally {
        chatSend.disabled = false;
      }
    }

    chatSend.addEventListener("click", sendChatMessage);

    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });

    // Ø±ÙØ¹ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø§Øª ÙÙˆÙ‚ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø¹Ù†Ø¯ Ø§Ù„ÙÙˆÙƒØ³
    chatInput.addEventListener("focus", () => {
      chatPanel.style.bottom = "320px";
    });

    chatInput.addEventListener("blur", () => {
      chatPanel.style.bottom = "70px";
    });
  </script>
</body>
</html>
