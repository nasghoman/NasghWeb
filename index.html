<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ù‚Ø±Ø§Ø¡Ø§Øª Ù†ÙØ³Øº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Ù„Ùˆ ÙØªØ­ØªÙ‡ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù…Ù† Ù…Ù„ÙØŒ Ø­ÙˆÙ‘Ù„Ù‡ Ø¥Ø¬Ø¨Ø§Ø±ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Vercel -->
  <script>
    if (location.protocol === "file:") {
      window.location.href = "https://nasgh.vercel.app";
    }
  </script>

  <style>
    :root {
      --nasgh-green: #4caf50;
      --nasgh-dark-green: #135a3b;
      --nasgh-yellow: #f1c232;
      --bg-light: #f5fff7;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, #eafff3, #f4fff9 40%, #ffffff 100%);
      margin: 0;
      padding: 16px;
      color: #123322;
    }

    .page {
      max-width: 980px;
      margin: 0 auto;
    }

    /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù…Ø¹ Ø§Ù„Ù„ÙˆØ¬Ùˆ */
    .topbar {
      background: #ffffff;
      border-radius: 18px;
      padding: 10px 18px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
      border: 1px solid #e0f2e9;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-img {
      width: 42px;
      height: auto;
    }

    .logo-text-main {
      font-weight: 700;
      font-size: 18px;
      color: var(--nasgh-dark-green);
      letter-spacing: 0.08em;
    }

    .logo-text-sub {
      font-size: 12px;
      color: #4a4a4a;
    }

    .topbar-right a {
      text-decoration: none;
      font-size: 13px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #c8e6c9;
      color: var(--nasgh-dark-green);
      background: #f5fff7;
      transition: 0.12s;
    }

    .topbar-right a:hover {
      background: linear-gradient(135deg, var(--nasgh-green), var(--nasgh-yellow));
      color: #ffffff;
      border-color: transparent;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
      padding: 16px 20px 20px;
      margin-bottom: 16px;
      border: 1px solid #e0f2e9;
    }

    h1 {
      font-size: 22px;
      margin-top: 0;
      margin-bottom: 8px;
      text-align: center;
      color: var(--nasgh-dark-green);
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      color: #4f6f5d;
      margin-bottom: 16px;
    }

    #status {
      font-size: 14px;
      margin-bottom: 12px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #e8f5e9;
      border: 1px solid #c8e6c9;
    }

    .error {
      background: #ffebee !important;
      border-color: #ffcdd2 !important;
      color: #b71c1c;
    }

    .btn {
      display: inline-block;
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--nasgh-green), var(--nasgh-yellow));
      color: #ffffff;
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.12s;
      box-shadow: 0 6px 16px rgba(19, 90, 59, 0.25);
    }

    .btn.secondary {
      background: #00695c;
      box-shadow: 0 6px 16px rgba(0, 105, 92, 0.25);
      margin-right: 6px;
    }

    .btn.ai {
      background: #1565c0;
      box-shadow: 0 6px 16px rgba(21, 101, 192, 0.25);
      margin-top: 4px;
    }

    .btn:active {
      transform: scale(0.98);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
    }

    .btn:disabled {
      background: #a5d6a7;
      box-shadow: none;
      cursor: default;
      transform: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 6px 4px;
      text-align: center;
    }

    th {
      background: #e0f2f1;
      font-weight: 600;
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    .reading-id {
      font-size: 13px;
      color: #607d8b;
      margin-bottom: 4px;
    }

    .time {
      font-size: 12px;
      color: #90a4ae;
      text-align: left;
    }

    .ai-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #1b5e20;
    }

    .ai-status {
      font-size: 13px;
      margin-bottom: 4px;
      color: #455a64;
    }

    .ai-box {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #cfd8dc;
      background: #fafafa;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    @media (max-width: 600px) {
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .topbar-right {
        align-self: stretch;
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù…Ø¹ Ø§Ù„Ù„ÙˆØ¬Ùˆ -->
    <header class="topbar">
      <div class="topbar-left">
        <!-- ØºÙŠÙ‘Ø± Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø­Ø³Ø¨ Ù…ÙƒØ§Ù† Ø§Ù„Ù„ÙˆØ¬Ùˆ Ø¹Ù†Ø¯Ùƒ -->
        <img src="images/nasgh-logo.png" alt="NASGH logo" class="logo-img" />
        <div>
          <div class="logo-text-main">NASGH Ù†Ø³Øº</div>
          <div class="logo-text-sub">Smart Soil Â· Smart Irrigation</div>
        </div>
      </div>
      <div class="topbar-right">
        <a href="login.html">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</a>
      </div>
    </header>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª -->
    <div class="card">
      <h1>Ù„ÙˆØ­Ø© Ù‚Ø±Ø§Ø¡Ø§Øª Ù†ÙØ³Øº</h1>
      <div class="subtitle">Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¨Ø§Ø± Ø¹Ø¨Ø± Bluetooth Low Energy Ø£Ùˆ Ø¹Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ± (ÙˆØ§ÙŠ ÙØ§ÙŠ)</div>

      <div id="status">Ø§Ù„Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù…ØªØµÙ„</div>

      <button id="connectBtn" class="btn">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø¨Ø§Ø±</button>
      <button id="disconnectBtn" class="btn secondary" disabled>Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„</button>
      <button id="cloudBtn" class="btn secondary">ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (ÙˆØ§ÙŠ ÙØ§ÙŠ)</button>
      <span id="cloudStatus" style="font-size:13px; color:#607d8b; margin-right:8px;"></span>

      <div class="reading-id" id="readingMeta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ø¨Ø¹Ø¯</div>
      <div class="time" id="timeLabel"></div>

      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ù‚ÙŠØ§Ø³</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©</td>
            <td id="tValue">-- Â°Ù…</td>
          </tr>
          <tr>
            <td>Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø©</td>
            <td id="mValue">-- Ùª</td>
          </tr>
          <tr>
            <td>Ø§Ù„Ù…Ù„ÙˆØ­Ø© (EC)</td>
            <td id="ecValue">-- ÂµS/cm</td>
          </tr>
          <tr>
            <td>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ù…ÙˆØ¶Ø© (pH)</td>
            <td id="phValue">-- pH</td>
          </tr>
          <tr>
            <td>Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ† (N)</td>
            <td id="nValue">-- mg/kg</td>
          </tr>
          <tr>
            <td>Ø§Ù„ÙÙˆØ³ÙÙˆØ± (P)</td>
            <td id="pValue">-- mg/kg</td>
          </tr>
          <tr>
            <td>Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… (K)</td>
            <td id="kValue">-- mg/kg</td>
          </tr>
          <tr>
            <td>Ù…Ø¤Ø´Ø± Ø§Ù„Ù‡ÙŠÙˆÙ…ÙŠÙƒ Ø£Ø³ÙŠØ¯</td>
            <td id="humValue">--</td>
          </tr>
          <tr>
            <td>Ù…Ø¤Ø´Ø± ØµØ­Ø© Ø§Ù„ØªØ±Ø¨Ø© (SHS)</td>
            <td id="shsValue">--</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø© ØªÙˆØµÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ -->
    <div class="card">
      <div class="ai-title">ØªÙˆØµÙŠØ© Ù†ÙØ³Øº Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
      <div class="ai-status" id="aiStatus">Ù„Ù… ÙŠØªÙ… Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠØ© Ø¨Ø¹Ø¯.</div>
      <button id="aiBtn" class="btn ai">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª ÙˆØ¥Ø¹Ø·Ø§Ø¡ ØªÙˆØµÙŠØ©</button>
      <div class="ai-box" id="aiAdvice">
        Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…ØªÙˆÙØ±Ø© ÙˆØªØ­Ù„ÙŠÙ„Ù‡Ø§ Ù„Ø¥Ø®Ø±Ø§Ø¬ ØªÙˆØµÙŠØ© Ø±ÙŠ ÙˆØªØ³Ù…ÙŠØ¯ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
      </div>
    </div>
  </div>

  <!-- ğŸ”’ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Auth -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCPCDnSjazRrxAZ1uVuwlvK5lBUYfmx4Io",
      authDomain: "nasgh1.firebaseapp.com",
      projectId: "nasgh1",
      storageBucket: "nasgh1.firebasestorage.app",
      messagingSenderId: "37730120812",
      appId: "1:37730120812:web:995e4f7d60cced8a709449",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ â†’ ÙŠØ±Ø¬Ø¹ Ù„ØµÙØ­Ø© Ø§Ù„Ù„ÙˆØ¬Ù†
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
      }
    });
  </script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« + AI (ÙŠØ¨Ù‚Ù‰ Ù…Ø«Ù„ Ù…Ø§ Ù‡Ùˆ) -->
  <script>
    // ================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª BLE (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„ÙƒÙˆØ¯ ESP32) ==================
    const SERVICE_UUID        = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
    const CHARACTERISTIC_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

    let device = null;
    let characteristic = null;
    let lastData = null; // Ù†Ø®Ø²Ù† Ø¢Ø®Ø± JSON Ù…Ø³ØªÙ„Ù… Ù…Ù† Ø§Ù„Ø¹ØµØ§ Ø£Ùˆ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±

    const statusEl   = document.getElementById("status");
    const connectBtn = document.getElementById("connectBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");

    const readingMetaEl = document.getElementById("readingMeta");
    const timeLabelEl   = document.getElementById("timeLabel");

    const aiStatusEl = document.getElementById("aiStatus");
    const aiAdviceEl = document.getElementById("aiAdvice");
    const aiBtn      = document.getElementById("aiBtn");

    const cloudBtn = document.getElementById("cloudBtn");
    const cloudStatusEl = document.getElementById("cloudStatus");

    const CLOUD_API_URL = "/api/soil-data";

    function setStatus(text, isError = false) {
      statusEl.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: " + text;
      statusEl.classList.toggle("error", isError);
    }

    function formatTime(d) {
      return d.toLocaleTimeString("ar", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
      });
    }

    function applyReading(data, sourceLabel = "Ø§Ù„Ù…Ø³Ø¨Ø§Ø±") {
      if (!data) return;

      lastData = data;

      const now = new Date();
      readingMetaEl.textContent = "Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ù†: " + (data.id || sourceLabel);
      timeLabelEl.textContent   = "Ø§Ù„ÙˆÙ‚Øª: " + formatTime(now);

      if (typeof data.t !== "undefined") {
        document.getElementById("tValue").textContent =
          Number(data.t).toFixed(1) + " Â°Ù…";
      }

      if (typeof data.m !== "undefined") {
        document.getElementById("mValue").textContent =
          Number(data.m).toFixed(1) + " Ùª";
      }

      if (typeof data.ec !== "undefined") {
        document.getElementById("ecValue").textContent =
          Number(data.ec).toFixed(0) + " ÂµS/cm";
      }

      if (typeof data.ph !== "undefined") {
        document.getElementById("phValue").textContent =
          Number(data.ph).toFixed(2) + " pH";
      }

      if (typeof data.n !== "undefined") {
        document.getElementById("nValue").textContent =
          Number(data.n).toFixed(0) + " mg/kg";
      }

      if (typeof data.p !== "undefined") {
        document.getElementById("pValue").textContent =
          Number(data.p).toFixed(0) + " mg/kg";
      }

      if (typeof data.k !== "undefined") {
        document.getElementById("kValue").textContent =
          Number(data.k).toFixed(0) + " mg/kg";
      }

      if (typeof data.hum !== "undefined") {
        document.getElementById("humValue").textContent =
          Number(data.hum).toFixed(1);
      }

      if (typeof data.shs !== "undefined") {
        document.getElementById("shsValue").textContent =
          Number(data.shs).toFixed(1);
      }
    }

    async function connect() {
      if (!navigator.bluetooth) {
        setStatus("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Web Bluetooth", true);
        alert("Web Bluetooth ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ø¬Ø±Ø¨ Google Chrome Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ø£Ùˆ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ØŒ Ø£Ùˆ Bluefy Ø¹Ù„Ù‰ iOS.");
        return;
      }

      try {
        setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³Ø¨Ø§Ø±...");
        connectBtn.disabled = true;

        device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }],
          optionalServices: [SERVICE_UUID]
        });

        device.addEventListener("gattserverdisconnected", onDisconnected);

        setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²...");
        const server = await device.gatt.connect();

        const service = await server.getPrimaryService(SERVICE_UUID);
        characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

        await characteristic.startNotifications();
        characteristic.addEventListener("characteristicvaluechanged", handleNotification);

        setStatus("Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø³Ø¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        disconnectBtn.disabled = false;

      } catch (err) {
        console.error(err);
        setStatus("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + err.message, true);
        connectBtn.disabled = false;
      }
    }

    function onDisconnected() {
      setStatus("ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø¨Ø§Ø±");
      disconnectBtn.disabled = true;
      connectBtn.disabled = false;
    }

    async function disconnect() {
      if (!device) return;
      try {
        await device.gatt.disconnect();
      } catch (e) {
        console.error(e);
      } finally {
        onDisconnected();
      }
    }

    function handleNotification(event) {
      const value = event.target.value;
      const decoder = new TextDecoder("utf-8");
      const text = decoder.decode(value);

      console.log("RAW BLE text:", text);

      try {
        const data = JSON.parse(text);
        applyReading(data, "Ø§Ù„Ù…Ø³Ø¨Ø§Ø± (BLE)");
      } catch (e) {
        console.error("JSON parse error:", e);
        setStatus("ÙˆÙØ¬Ø¯Øª Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ«", true);
      }
    }

    connectBtn.addEventListener("click", connect);
    disconnectBtn.addEventListener("click", disconnect);

    async function loadCloudData() {
      cloudStatusEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...";
      try {
        const res = await fetch(CLOUD_API_URL, { method: "GET" });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const data = await res.json();
        if (!data || Object.keys(data).length === 0) {
          cloudStatusEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Ø¯.";
          return;
        }

        applyReading(data, "Ø§Ù„Ø³ÙŠØ±ÙØ± (WiFi)");
        cloudStatusEl.textContent = "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± âœ…";

      } catch (err) {
        console.error(err);
        cloudStatusEl.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±: " + err.message;
      }
    }

    cloudBtn.addEventListener("click", loadCloudData);

    const AI_API_URL = "/api/nasgh-ai";

    async function callAI() {
      if (!lastData) {
        aiStatusEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ø­Ø¯ÙŠØ«Ø© Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³Ø¨Ø§Ø± Ø£Ùˆ Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.";
        return;
      }

      aiBtn.disabled = true;
      aiStatusEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„Ù‡Ø§...";
      aiAdviceEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ...";

      try {
        const payload = {
          soil: {
            id:   lastData.id || "NASGH-1",
            temp: lastData.t,
            moisture: lastData.m,
            ec:   lastData.ec,
            ph:   lastData.ph,
            n:    lastData.n,
            p:    lastData.p,
            k:    lastData.k,
            shs:  lastData.shs,
            humic: lastData.hum
          },
          language: "ar"
        };

        const res = await fetch(AI_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const adviceText = await res.text();

        aiStatusEl.textContent = "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªÙˆØµÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…";
        aiAdviceEl.textContent = adviceText;

      } catch (err) {
        console.error(err);
        aiStatusEl.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠØ©.";
        aiAdviceEl.textContent = "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.\n\nØ§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ù†ÙŠØ©: " + err.message;
      } finally {
        aiBtn.disabled = false;
      }
    }

    aiBtn.addEventListener("click", callAI);
  </script>
</body>
</html>
