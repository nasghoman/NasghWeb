<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ù†ÙØ³Øº â€“ Ø¢Ø®Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --nasgh-green: #2e7d32;
      --nasgh-green-soft: #e8f5e9;
      --nasgh-green-dark: #135a3b;
      --nasgh-yellow: #f1c232;
      --bg: #f5fff7;
      --card-bg: #ffffff;
      --border: #e0f2e9;
      --text-main: #123322;
      --text-sub: #607d8b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #eafff3, #f4fff9 45%, #ffffff 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .layout {
      max-width: 1080px;
      margin: 0 auto;
      padding: 12px 10px 80px;
    }

    /* ======= TOP BAR ======= */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 10px 14px;
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      border: 1px solid var(--border);
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-img {
      width: 40px;
      height: auto;
    }

    .logo-text-main {
      font-weight: 800;
      font-size: 18px;
      color: var(--nasgh-green-dark);
      letter-spacing: 0.06em;
    }

    .logo-text-ar {
      font-size: 14px;
      font-weight: 600;
      color: var(--nasgh-green-dark);
    }

    .logo-text-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .topbar-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 12px;
      font-size: 12px;
      background: #f2fff6;
      color: var(--nasgh-green-dark);
      text-decoration: none;
      cursor: pointer;
      transition: 0.15s;
      white-space: nowrap;
    }

    .pill-btn:hover {
      background: linear-gradient(135deg, var(--nasgh-green), var(--nasgh-yellow));
      color: #ffffff;
      border-color: transparent;
    }

    /* ====== CARDS / GRID ====== */

    .grid-main {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.1fr);
      gap: 12px;
      align-items: flex-start;
      margin-top: 6px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
      padding: 12px 14px 14px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--nasgh-green-dark);
    }

    .card-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .status-badge {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: var(--nasgh-green-soft);
      color: var(--nasgh-green-dark);
    }

    .status-badge.error {
      background: #ffebee;
      color: #b71c1c;
      border: 1px solid #ffcdd2;
    }

    /* ====== SUMMARY STATS ====== */

    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .stat {
      background: #f7fff9;
      border-radius: 12px;
      padding: 8px 8px;
      border: 1px solid var(--border);
      font-size: 12px;
    }

    .stat-label {
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--nasgh-green-dark);
    }

    .plant-stage-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--nasgh-green-dark);
      margin-top: 6px;
    }

    .plant-stage-chip {
      display: inline-block;
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: #fff8e1;
      color: #f57f17;
      margin-top: 4px;
    }

    /* ====== TABLE ====== */

    .table-wrapper {
      margin-top: 8px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      min-width: 650px;
      border-collapse: collapse;
      font-size: 12px;
    }

    th,
    td {
      border: 1px solid #e0e0e0;
      padding: 6px 4px;
      text-align: center;
      vertical-align: middle;
    }

    th {
      background: #e0f2f1;
      font-weight: 600;
      font-size: 11px;
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    .advice-cell {
      text-align: right;
      font-size: 11px;
      line-height: 1.5;
    }

    .stage-cell {
      font-size: 11px;
    }

    .stage-chip-small {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #fff3e0;
      color: #ef6c00;
      font-size: 10px;
    }

    /* ====== CHARTS ====== */

    .chart-tabs {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .chart-tab {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid #d0e3ff;
      background: #e3f2fd;
      color: #1565c0;
    }

    .chart-container {
      position: relative;
      height: 210px;
      margin-top: 6px;
    }

    .chart-title {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    /* ====== CHAT BOT ====== */

    .chat-toggle {
      position: fixed;
      bottom: 14px;
      left: 14px;
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--nasgh-green), var(--nasgh-yellow));
      color: #ffffff;
      font-size: 13px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 1000;
    }

    .chat-toggle span {
      font-size: 16px;
    }

    .chat-panel {
      position: fixed;
      bottom: 70px;
      left: 10px;
      right: 10px;
      max-width: 380px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.35);
      border: 1px solid var(--border);
      display: none;
      flex-direction: column;
      overflow: hidden;
      max-height: 70vh;
      z-index: 1001;
      transition: bottom 0.25s ease;
    }

    .chat-header {
      padding: 8px 10px;
      border-bottom: 1px solid #e0f2e9;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      background: #f5fff7;
    }

    .chat-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--nasgh-green-dark);
    }

    .chat-status {
      font-size: 11px;
      color: var(--text-sub);
    }

    .chat-close {
      border: none;
      background: transparent;
      font-size: 16px;
      cursor: pointer;
      color: #607d8b;
    }

    .chat-messages {
      padding: 10px;
      overflow-y: auto;
      flex: 1;
      background: #ffffff;
    }

    .chat-msg {
      margin-bottom: 8px;
      font-size: 12px;
      line-height: 1.6;
    }

    .chat-msg.user {
      text-align: left;
      direction: ltr;
    }

    .chat-msg.assistant {
      background: #f5fff7;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid var(--border);
    }

    .chat-input-row {
      border-top: 1px solid #e0f2e9;
      padding: 6px;
      display: flex;
      gap: 6px;
      background: #fafafa;
    }

    .chat-input-row textarea {
      flex: 1;
      resize: none;
      border-radius: 10px;
      border: 1px solid #cfd8dc;
      padding: 6px 8px;
      font-size: 12px;
      min-height: 34px;
      max-height: 70px;
    }

    .chat-input-row button {
      border-radius: 999px;
      border: none;
      padding: 0 12px;
      font-size: 12px;
      background: var(--nasgh-green);
      color: #ffffff;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    /* ====== RESPONSIVE ====== */

    @media (max-width: 860px) {
      .grid-main {
        grid-template-columns: minmax(0, 1fr);
      }

      .stats-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .topbar {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 480px) {
      .layout {
        padding: 10px 8px 80px;
      }
      .card {
        padding: 10px 10px 12px;
      }
      .chart-container {
        height: 190px;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- TOP BAR -->
    <header class="topbar">
      <div class="topbar-left">
        <img src="images/nasgh-logo.png" alt="NASGH" class="logo-img" />
        <div>
          <div class="logo-text-ar">Ù†ÙØ³Øº</div>
          <div class="logo-text-main">NASGH</div>
          <div class="logo-text-sub">Smart Soil Â· Smart Irrigation</div>
        </div>
      </div>

      <div class="topbar-right">
        <a href="index.html" class="pill-btn">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</a>
        <button id="switchAccountBtn" class="pill-btn">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
      </div>
    </header>

    <!-- MAIN GRID -->
    <div class="grid-main">
      <!-- LEFT: last readings + table -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Ø¢Ø®Ø± Ù¡Ù  Ù‚Ø±Ø§Ø¡Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</div>
            <div id="historyRange" class="card-sub">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
          </div>
          <div id="historyStatus" class="status-badge">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        </div>

        <!-- SUMMARY -->
        <div class="stats-row">
          <div class="stat">
            <div class="stat-label">Ø¢Ø®Ø± Ø±Ø·ÙˆØ¨Ø©</div>
            <div id="statMoisture" class="stat-value">-- Ùª</div>
          </div>
          <div class="stat">
            <div class="stat-label">Ø¢Ø®Ø± Ø¯Ø±Ø¬Ø© Ø­Ø±Ø§Ø±Ø©</div>
            <div id="statTemp" class="stat-value">-- Â°Ù…</div>
          </div>
          <div class="stat">
            <div class="stat-label">Ù…ØªÙˆØ³Ø· pH</div>
            <div id="statPh" class="stat-value">--</div>
          </div>
          <div class="stat">
            <div class="stat-label">Ù…ØªÙˆØ³Ø· SHS</div>
            <div id="statShs" class="stat-value">--</div>
          </div>
        </div>

        <div class="plant-stage-title">Ù…Ø±Ø­Ù„Ø© Ù†Ù…Ùˆ Ø§Ù„Ù†Ø¨Ø§Øª (Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø©)</div>
        <div id="plantStageLabel" class="card-sub" style="margin-top:2px;">-</div>
        <div id="plantStageChip" class="plant-stage-chip">Ù…Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø¹Ø¯</div>

        <!-- TABLE -->
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Ø§Ù„ÙˆÙ‚Øª</th>
                <th>Ø±Ø·ÙˆØ¨Ø© %</th>
                <th>Â°Ù…</th>
                <th>pH</th>
                <th>EC ÂµS/cm</th>
                <th>SHS</th>
                <th>Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ù…Ùˆ</th>
                <th>Ù†ØµÙŠØ­Ø© Ù†ÙØ³Øº AI</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              <tr>
                <td colspan="9">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- RIGHT: charts -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ©</div>
            <div class="card-sub">Moisture &amp; Temp Â· NPK Â· SHS</div>
          </div>
        </div>

        <div class="chart-tabs">
          <span class="chart-tab">Moisture &amp; Temperature</span>
          <span class="chart-tab">N Â· P Â· K</span>
          <span class="chart-tab">SHS Index</span>
        </div>

        <div class="chart-container">
          <canvas id="chartMoistTemp"></canvas>
        </div>
        <div class="chart-title">Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø© (%) ÙˆØ¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°Ù…) Ø¹Ø¨Ø± Ø§Ù„ÙˆÙ‚Øª</div>

        <div class="chart-container">
          <canvas id="chartNpk"></canvas>
        </div>
        <div class="chart-title">NPK (mg/kg) Ø¹Ø¨Ø± Ø§Ù„ÙˆÙ‚Øª</div>

        <div class="chart-container">
          <canvas id="chartShs"></canvas>
        </div>
        <div class="chart-title">Ù…Ø¤Ø´Ø± ØµØ­Ø© Ø§Ù„ØªØ±Ø¨Ø© SHS Ø¹Ø¨Ø± Ø§Ù„ÙˆÙ‚Øª</div>
      </section>
    </div>
  </div>

  <!-- CHAT BOT BUTTON + PANEL -->
  <button id="chatToggle" class="chat-toggle">
    <span>ğŸ’¬</span> Ù†Ø³Øº AI
  </button>

  <section id="chatPanel" class="chat-panel">
    <div class="chat-header">
      <div>
        <div class="chat-title">Ù…Ø³Ø§Ø¹Ø¯ Ù†ÙØ³Øº</div>
        <div id="chatStatus" class="chat-status">Ø¬Ø§Ù‡Ø² Ù„Ø£Ø³Ø¦Ù„ØªÙƒ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© ğŸŒ¿</div>
      </div>
      <button class="chat-close" id="chatCloseBtn">&times;</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input-row">
      <textarea id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø¹Ù† Ø§Ù„ØªØ±Ø¨Ø© Ø£Ùˆ Ø§Ù„Ø±ÙŠ Ø£Ùˆ Ø§Ù„ØªØ³Ù…ÙŠØ¯..."></textarea>
      <button id="chatSend">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </section>

  <script>
    // ======== DATA LOADING FROM FIREBASE ========
    // Ù†Ù‚Ø±Ø£ Ø¢Ø®Ø± Ù¡Ù  Ù‚Ø±Ø§Ø¡Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± soil-history
    const HISTORY_API_URL =
      "https://nasgh1-default-rtdb.firebaseio.com/soil-history.json?orderBy=%22timestamp%22&limitToLast=10";

    let historyData = [];
    let chartMoistTemp = null;
    let chartNpk = null;
    let chartShs = null;

    function formatTime(ts) {
      if (!ts) return "--";
      const dt = new Date(ts);
      return dt.toLocaleString("ar-EG", {
        weekday: "short",
        hour: "2-digit",
        minute: "2-digit",
        day: "numeric",
        month: "short"
      });
    }

    function updateSummaryAndTable() {
      const historyBody = document.getElementById("historyBody");
      const statusEl = document.getElementById("historyStatus");
      const rangeEl = document.getElementById("historyRange");
      const statMoisture = document.getElementById("statMoisture");
      const statTemp = document.getElementById("statTemp");
      const statPh = document.getElementById("statPh");
      const statShs = document.getElementById("statShs");
      const stageLabel = document.getElementById("plantStageLabel");
      const stageChip = document.getElementById("plantStageChip");

      if (!historyData.length) {
        historyBody.innerHTML =
          '<tr><td colspan="9">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.</td></tr>';
        statusEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª";
        statusEl.classList.remove("error");
        rangeEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ø¨Ø¹Ø¯.";
        return;
      }

      // ØªØ£ÙƒØ¯ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
      historyData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      const latest = historyData[0];
      const last = historyData[historyData.length - 1];

      rangeEl.textContent =
        "Ø¢Ø®Ø± " +
        historyData.length +
        " Ù‚Ø±Ø§Ø¡Ø§Øª Ù…Ù† " +
        formatTime(last.timestamp) +
        " Ø¥Ù„Ù‰ " +
        formatTime(latest.timestamp);

      statusEl.textContent = "ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«";
      statusEl.classList.remove("error");

      // Summary
      statMoisture.textContent =
        (latest.m != null && !isNaN(latest.m) ? latest.m.toFixed(1) : "--") + " Ùª";
      statTemp.textContent =
        (latest.t != null && !isNaN(latest.t) ? latest.t.toFixed(1) : "--") + " Â°Ù…";

      const avgPh =
        historyData.reduce((sum, r) => sum + (r.ph || 0), 0) /
        historyData.length;
      const avgShs =
        historyData.reduce((sum, r) => sum + (r.shs || 0), 0) /
        historyData.length;

      statPh.textContent =
        isFinite(avgPh) && avgPh > 0 ? avgPh.toFixed(2) : "--";
      statShs.textContent =
        isFinite(avgShs) && avgShs > 0 ? avgShs.toFixed(1) : "--";

      stageLabel.textContent = latest.stage || "Ù…Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
      stageChip.textContent = latest.stage || "Ù…Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø¹Ø¯";

      // Table
      historyBody.innerHTML = "";
      historyData.forEach((row, idx) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${formatTime(row.timestamp)}</td>
          <td>${row.m != null && !isNaN(row.m) ? row.m.toFixed(1) : "--"}</td>
          <td>${row.t != null && !isNaN(row.t) ? row.t.toFixed(1) : "--"}</td>
          <td>${row.ph != null && !isNaN(row.ph) ? row.ph.toFixed(2) : "--"}</td>
          <td>${row.ec != null && !isNaN(row.ec) ? row.ec.toFixed(0) : "--"}</td>
          <td>${row.shs != null && !isNaN(row.shs) ? row.shs.toFixed(1) : "--"}</td>
          <td class="stage-cell">
            ${
              row.stage
                ? `<span class="stage-chip-small">${row.stage}</span>`
                : "--"
            }
          </td>
          <td class="advice-cell">${
            row.advice ? row.advice : "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØµÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©."
          }</td>
        `;
        historyBody.appendChild(tr);
      });
    }

    function updateCharts() {
      const sorted = historyData
        .slice()
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      const labels = sorted.map((r) =>
        new Date(r.timestamp).toLocaleTimeString("ar-EG", {
          hour: "2-digit",
          minute: "2-digit"
        })
      );

      const moistArr = sorted.map((r) => (r.m && !isNaN(r.m) ? r.m : 0));
      const tempArr  = sorted.map((r) => (r.t && !isNaN(r.t) ? r.t : 0));

      const nArr = sorted.map((r) => (r.n && !isNaN(r.n) ? r.n : 0));
      const pArr = sorted.map((r) => (r.p && !isNaN(r.p) ? r.p : 0));
      const kArr = sorted.map((r) => (r.k && !isNaN(r.k) ? r.k : 0));

      const shsArr = sorted.map((r) => (r.shs && !isNaN(r.shs) ? r.shs : 0));

      // Destroy old charts if they exist
      if (chartMoistTemp) chartMoistTemp.destroy();
      if (chartNpk) chartNpk.destroy();
      if (chartShs) chartShs.destroy();

      const ctx1 = document.getElementById("chartMoistTemp").getContext("2d");
      chartMoistTemp = new Chart(ctx1, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø© Ùª",
              data: moistArr,
              borderWidth: 2,
              tension: 0.3
            },
            {
              label: "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Â°Ù…",
              data: tempArr,
              borderWidth: 2,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "top", labels: { font: { size: 11 } } }
          },
          scales: {
            x: { ticks: { font: { size: 10 } } },
            y: { ticks: { font: { size: 10 } } }
          }
        }
      });

      const ctx2 = document.getElementById("chartNpk").getContext("2d");
      chartNpk = new Chart(ctx2, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "N (mg/kg)",
              data: nArr,
              borderWidth: 2,
              tension: 0.3
            },
            {
              label: "P (mg/kg)",
              data: pArr,
              borderWidth: 2,
              tension: 0.3
            },
            {
              label: "K (mg/kg)",
              data: kArr,
              borderWidth: 2,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "top", labels: { font: { size: 11 } } }
          },
          scales: {
            x: { ticks: { font: { size: 10 } } },
            y: { ticks: { font: { size: 10 } } }
          }
        }
      });

      const ctx3 = document.getElementById("chartShs").getContext("2d");
      chartShs = new Chart(ctx3, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "SHS",
              data: shsArr,
              borderWidth: 2,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "top", labels: { font: { size: 11 } } }
          },
          scales: {
            x: { ticks: { font: { size: 10 } } },
            y: { ticks: { font: { size: 10 } } }
          }
        }
      });
    }

    async function loadHistory() {
      const statusEl = document.getElementById("historyStatus");
      statusEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
      statusEl.classList.remove("error");

      try {
        const res = await fetch(HISTORY_API_URL);
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const raw = await res.json() || {};

        // raw = {pushId1: reading1, pushId2: reading2, ...}
        historyData = Object.values(raw).map((r) => {
          return {
            timestamp: r.timestamp || null,
            t:   Number(r.t   ?? r.temp     ?? NaN),
            m:   Number(r.m   ?? r.moisture ?? NaN),
            ec:  Number(r.ec  ?? NaN),
            ph:  Number(r.ph  ?? NaN),
            n:   Number(r.n   ?? NaN),
            p:   Number(r.p   ?? NaN),
            k:   Number(r.k   ?? NaN),
            shs: Number(r.shs ?? NaN),
            stage:  r.stage  || "",
            advice: r.advice || ""
          };
        });

        updateSummaryAndTable();
        if (historyData.length) updateCharts();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message;
        statusEl.classList.add("error");
      }
    }

    // ======== CHAT BOT ========
    const CHAT_API_URL = "/api/nasgh-chat";
    const chatToggle = document.getElementById("chatToggle");
    const chatPanel = document.getElementById("chatPanel");
    const chatCloseBtn = document.getElementById("chatCloseBtn");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");
    const chatStatus = document.getElementById("chatStatus");

    let chatHistory = [];

    function appendMessage(role, text) {
      const div = document.createElement("div");
      div.className = "chat-msg " + role;
      div.textContent = text;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendChatMessage() {
      const text = chatInput.value.trim();
      if (!text) return;

      appendMessage("user", text);
      chatHistory.push({ role: "user", content: text });
      chatInput.value = "";
      chatStatus.textContent = "Ù†ÙØ³Øº ÙŠØ­Ø¶Ù‘Ø± Ù„Ùƒ Ø¬ÙˆØ§Ø¨ Ù…Ø¨Ø³Ø·...";

      try {
        const payload = {
          message: text,
          history: chatHistory
        };

        const res = await fetch(CHAT_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const data = await res.json();
        const reply =
          data.reply ||
          "ØµØ§Ø± Ø¹Ù†Ø¯ÙŠ ØªØ¹Ø°Ù‘Ø± Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„Ø±Ø¯ØŒ Ø¬Ø±Ù‘Ø¨ ØªØ¹ÙŠØ¯ Ø³Ø¤Ø§Ù„Ùƒ Ø£Ùˆ ØºÙŠÙ‘Ø± ØµÙŠØ§ØºØªÙ‡ Ø´ÙˆÙŠ Ø£Ø®ÙˆÙŠ.";

        appendMessage("assistant", reply);
        chatHistory.push({ role: "assistant", content: reply });
        chatStatus.textContent = "Ø¬Ø§Ù‡Ø² Ù„Ø³Ø¤Ø§Ù„ Ø²Ø±Ø§Ø¹ÙŠ Ø¬Ø¯ÙŠØ¯ ğŸŒ¿";
      } catch (err) {
        console.error(err);
        appendMessage(
          "assistant",
          "Ø­ÙŠØ§Ùƒ Ø£Ø®ÙˆÙŠØŒ ØµØ§Ø± Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ¬Ø±Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©."
        );
        chatStatus.textContent = "ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø¬Ø±Ù‘Ø¨ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.";
      }
    }

    chatToggle.addEventListener("click", () => {
      const isOpen = chatPanel.style.display === "flex";
      chatPanel.style.display = isOpen ? "none" : "flex";
    });

    chatCloseBtn.addEventListener("click", () => {
      chatPanel.style.display = "none";
    });

    chatSend.addEventListener("click", sendChatMessage);

    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });

    // Ø±ÙØ¹ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø§Øª ÙÙˆÙ‚ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    chatInput.addEventListener("focus", () => {
      chatPanel.style.bottom = "280px";
    });

    chatInput.addEventListener("blur", () => {
      chatPanel.style.bottom = "70px";
    });

    // ======== INIT ========
    document.addEventListener("DOMContentLoaded", () => {
      loadHistory();
      appendMessage(
        "assistant",
        "Ø­ÙŠØ§Ùƒ Ø£Ø®ÙˆÙŠØŒ Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ù†ÙØ³Øº Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø§Ù„ØªØ±Ø¨Ø©ØŒ Ø§Ù„Ø±ÙŠ Ø£Ùˆ Ø§Ù„ØªØ³Ù…ÙŠØ¯ ÙˆØ¨Ø¬Ø§ÙˆØ¨Ùƒ Ø¨Ø£Ø¨Ø³Ø· Ø·Ø±ÙŠÙ‚Ø© Ø£Ù‚Ø¯Ø± Ø¹Ù„ÙŠÙ‡Ø§ ğŸŒ¿"
      );
    });
  </script>
</body>
</html>
