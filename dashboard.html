<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„Ø§Øª Ù†ÙØ³Øº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --nasgh-green: #4caf50;
      --nasgh-dark-green: #135a3b;
      --nasgh-yellow: #f1c232;
      --bg-light: #f5fff7;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, #eafff3, #f4fff9 40%, #ffffff 100%);
      color: #123322;
    }

    .page {
      max-width: 1150px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 80px;
    }

    /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù…Ø¹ Ø§Ù„Ù„ÙˆØ¬Ùˆ */
    .topbar {
      background: #ffffff;
      border-radius: 18px;
      padding: 10px 18px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
      border: 1px solid #e0f2e9;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-img {
      width: 42px;
      height: auto;
    }

    .logo-text-main {
      font-weight: 700;
      font-size: 18px;
      color: var(--nasgh-dark-green);
      letter-spacing: 0.08em;
    }

    .logo-text-sub {
      font-size: 12px;
      color: #4a4a4a;
    }

    .topbar-right a {
      text-decoration: none;
      font-size: 13px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #c8e6c9;
      color: var(--nasgh-dark-green);
      background: #f5fff7;
      transition: 0.12s;
      margin-left: 6px;
    }

    .topbar-right a:hover {
      background: linear-gradient(135deg, var(--nasgh-green), var(--nasgh-yellow));
      color: #ffffff;
      border-color: transparent;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.6fr 1.1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
      padding: 16px 18px 18px;
      border: 1px solid #e0f2e9;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--nasgh-dark-green);
    }

    .card-sub {
      font-size: 12px;
      color: #607d8b;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    .stat {
      background: #f5fff7;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid #e0f2e9;
      font-size: 13px;
    }

    .stat-label {
      color: #607d8b;
      margin-bottom: 4px;
    }

    .stat-value {
      font-weight: 600;
      color: #1b5e20;
    }

    .stat-chip {
      display: inline-block;
      margin-top: 4px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e8f5e9;
      color: #2e7d32;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 6px 4px;
      text-align: center;
    }

    th {
      background: #e0f2f1;
      font-weight: 600;
      font-size: 12px;
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    .advice-cell {
      text-align: right;
      font-size: 12px;
      line-height: 1.5;
    }

    .stage-chip {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #fff8e1;
      color: #f57f17;
      font-size: 11px;
    }

    .chart-container {
      position: relative;
      height: 260px;
      margin-top: 8px;
    }

    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e3f2fd;
      color: #1565c0;
      margin-right: 4px;
    }

    .empty-msg {
      font-size: 13px;
      color: #78909c;
      margin-top: 6px;
    }

    /* Ø´Ø§Øª Ø¨ÙˆØª Ù†Ø³Øº */
    .chat-toggle {
      position: fixed;
      bottom: 16px;
      left: 16px;
      z-index: 50;
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      background: linear-gradient(135deg, var(--nasgh-green), var(--nasgh-yellow));
      color: #ffffff;
      font-size: 13px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.25);
      cursor: pointer;
    }

    .chat-panel {
      position: fixed;
      bottom: 70px;
      left: 16px;
      width: 320px;
      max-height: 70vh;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.3);
      border: 1px solid #e0f2e9;
      display: none;
      flex-direction: column;
      z-index: 60;
      overflow: hidden;
    }

    .chat-header {
      padding: 10px 12px;
      border-bottom: 1px solid #e0f2e9;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f5fff7;
    }

    .chat-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--nasgh-dark-green);
    }

    .chat-subtitle {
      font-size: 11px;
      color: #607d8b;
    }

    .chat-close {
      border: none;
      background: none;
      font-size: 16px;
      cursor: pointer;
      color: #78909c;
    }

    .chat-body {
      padding: 10px;
      overflow-y: auto;
      flex: 1;
      background: #fafafa;
    }

    .msg {
      margin-bottom: 8px;
      max-width: 90%;
    }

    .msg.user {
      margin-left: auto;
      text-align: left;
    }

    .msg.assistant {
      margin-right: auto;
      text-align: right;
    }

    .bubble {
      display: inline-block;
      padding: 7px 10px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .msg.user .bubble {
      background: #e3f2fd;
      color: #0d47a1;
      border-top-right-radius: 2px;
    }

    .msg.assistant .bubble {
      background: #e8f5e9;
      color: #1b5e20;
      border-top-left-radius: 2px;
    }

    .msg-meta {
      font-size: 10px;
      color: #90a4ae;
      margin-top: 2px;
    }

    .chat-footer {
      padding: 8px;
      border-top: 1px solid #e0f2e9;
      background: #ffffff;
      display: flex;
      gap: 6px;
    }

    .chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #cfd8dc;
      padding: 6px 10px;
      font-size: 13px;
      outline: none;
    }

    .chat-send {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      background: #2e7d32;
      color: #ffffff;
      font-size: 12px;
      cursor: pointer;
    }

    .chat-status {
      font-size: 10px;
      color: #90a4ae;
      padding: 0 10px 6px;
    }

    @media (max-width: 800px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .chat-panel {
        left: 8px;
        right: 8px;
        width: auto;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <header class="topbar">
      <div class="topbar-left">
        <img src="images/nasgh-logo.png" alt="NASGH logo" class="logo-img" />
        <div>
          <div class="logo-text-main">NASGH Ù†Ø³Øº</div>
          <div class="logo-text-sub">Smart Soil Â· Smart Irrigation</div>
        </div>
      </div>
      <div class="topbar-right">
        <a href="index.html">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</a>
        <a href="login.html">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</a>
      </div>
    </header>

    <!-- Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: Ù…Ù„Ø®Øµ + Ø¬Ø¯ÙˆÙ„ + Ø±Ø³ÙˆÙ…Ø§Øª -->
    <div class="grid">
      <!-- ÙŠØ³Ø§Ø±: Ù…Ù„Ø®Øµ + Ø¬Ø¯ÙˆÙ„ Ø¢Ø®Ø± 10 Ù‚Ø±Ø§Ø¡Ø§Øª -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Ø¢Ø®Ø± Ù¡Ù  Ù‚Ø±Ø§Ø¡Ø§Øª</div>
          <div class="card-sub" id="historyMeta">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
        </div>

        <div class="stats-row">
          <div class="stat">
            <div class="stat-label">Ø¢Ø®Ø± Ø±Ø·ÙˆØ¨Ø©</div>
            <div class="stat-value" id="statMoisture">-- Ùª</div>
          </div>
          <div class="stat">
            <div class="stat-label">Ø¢Ø®Ø± Ø¯Ø±Ø¬Ø© Ø­Ø±Ø§Ø±Ø©</div>
            <div class="stat-value" id="statTemp">-- Â°Ù…</div>
          </div>
          <div class="stat">
            <div class="stat-label">Ù…ØªÙˆØ³Ø· pH</div>
            <div class="stat-value" id="statPh">--</div>
          </div>
          <div class="stat">
            <div class="stat-label">Ù…ØªÙˆØ³Ø· SHS</div>
            <div class="stat-value" id="statShs">--</div>
          </div>
        </div>

        <div class="stat" style="margin-top:8px;">
          <div class="stat-label">Ù…Ø±Ø­Ù„Ø© Ù†Ù…Ùˆ Ø§Ù„Ù†Ø¨Ø§Øª (Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø©)</div>
          <div class="stat-value" id="statStage">--</div>
          <div class="stat-chip" id="statStageChip">Ù…Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø¹Ø¯</div>
        </div>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø±Ø·ÙˆØ¨Ø© Ùª</th>
              <th>Â°Ù…</th>
              <th>pH</th>
              <th>EC</th>
              <th>SHS</th>
              <th>Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ù…Ùˆ</th>
              <th>Ù†ØµÙŠØ­Ø© Ù†Ø³Øº AI</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <!-- Ø§Ù„ØµÙÙˆÙ ØªØ¹Ø¨Ù‘Ù‰ Ù…Ù† JS -->
          </tbody>
        </table>

        <div class="empty-msg" id="historyEmptyMsg" style="display:none;">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª ÙƒØ§ÙÙŠØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ø£ÙˆÙ„ Ù…Ø§ ØªÙˆØµÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø¨Ø§Ø± Ø£Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ ğŸŒ±
        </div>
      </div>

      <!-- ÙŠÙ…ÙŠÙ†: Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ©</div>
          <div class="card-sub">
            <span class="tag">Moisture</span>
            <span class="tag">Temperature</span>
            <span class="tag">pH &amp; EC</span>
            <span class="tag">SHS</span>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="chartMoisture"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="chartTemp"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="chartPhEc"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="chartShs"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø²Ø± ÙØªØ­ Ø´Ø§Øª Ø¨ÙˆØª Ù†Ø³Øº -->
  <button class="chat-toggle" id="chatToggle">
    ğŸ’¬ Ù†Ø³Øº AI
  </button>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø§Øª -->
  <div class="chat-panel" id="chatPanel">
    <div class="chat-header">
      <div>
        <div class="chat-title">Ù…Ø³Ø§Ø¹Ø¯ Ù†ÙØ³Øº</div>
        <div class="chat-subtitle">ÙŠØ±Ø¯ Ø¹Ù„ÙŠÙƒ Ø¹Ø±Ø¨ÙŠ + Ù„Ù…Ø³Ø© Ø¹Ù…Ø§Ù†ÙŠØ© ğŸ˜‰</div>
      </div>
      <button class="chat-close" id="chatClose">&times;</button>
    </div>
    <div class="chat-body" id="chatBody">
      <div class="msg assistant">
        <div class="bubble">
          Ù‡Ù„Ø§ ÙˆØ³Ù‡Ù„Ø§ ğŸ‘‹  
          Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ù†ÙØ³ØºØŒ Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±Ø¨Ø©ØŒ Ø§Ù„ØªØ³Ù…ÙŠØ¯ØŒ Ø§Ù„Ø±ÙŠØŒ Ø£Ùˆ Ø£ÙŠ Ø´ÙŠ ÙŠØ®Ø·Ø± ÙÙŠ Ø¨Ø§Ù„Ùƒ Ø¹Ù† Ù…Ø²Ø±Ø¹ØªÙƒØŒ ÙˆØ¨Ø¹Ø·ÙŠÙƒ Ø´Ø±Ø­ Ù…Ø¨Ø³Ù‘Ø· Ø¹Ù„Ù‰ Ø¬ÙˆÙ‘Ù†Ø§ Ø§Ù„Ø¹Ù…Ø§Ù†ÙŠ ğŸŒ´
        </div>
        <div class="msg-meta">Ù†ÙØ³Øº AI</div>
      </div>
    </div>
    <div class="chat-status" id="chatStatus">Ø¬Ø§Ù‡Ø² Ù„Ø³Ù…Ø§Ø¹ Ø³Ø¤Ø§Ù„Ùƒ ğŸŒ±</div>
    <div class="chat-footer">
      <input type="text" id="chatInput" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." />
      <button id="chatSend" class="chat-send">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø© Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API ==================
    const HISTORY_API_URL = "/api/soil-history?limit=10"; // Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
    const CHAT_API_URL = "/api/nasgh-chat";               // Endpoint Ø§Ù„Ø´Ø§Øª Ù…Ø¹ Gemini

    let historyData = [];
    let charts = {};

    function formatTimeLabel(ts) {
      try {
        const d = new Date(ts);
        return d.toLocaleString("ar", {
          month: "short",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        });
      } catch {
        return ts;
      }
    }

    function fillHistoryTable() {
      const tbody = document.getElementById("historyTableBody");
      const emptyMsg = document.getElementById("historyEmptyMsg");
      tbody.innerHTML = "";

      if (!historyData.length) {
        emptyMsg.style.display = "block";
        return;
      }
      emptyMsg.style.display = "none";

      historyData.forEach((row, idx) => {
        const tr = document.createElement("tr");

        const indexCell = document.createElement("td");
        indexCell.textContent = idx + 1;
        tr.appendChild(indexCell);

        const timeCell = document.createElement("td");
        timeCell.textContent = row.timestamp ? formatTimeLabel(row.timestamp) : "--";
        tr.appendChild(timeCell);

        const mCell = document.createElement("td");
        mCell.textContent = typeof row.m !== "undefined" ? Number(row.m).toFixed(1) : "--";
        tr.appendChild(mCell);

        const tCell = document.createElement("td");
        tCell.textContent = typeof row.t !== "undefined" ? Number(row.t).toFixed(1) : "--";
        tr.appendChild(tCell);

        const phCell = document.createElement("td");
        phCell.textContent = typeof row.ph !== "undefined" ? Number(row.ph).toFixed(2) : "--";
        tr.appendChild(phCell);

        const ecCell = document.createElement("td");
        ecCell.textContent = typeof row.ec !== "undefined" ? Number(row.ec).toFixed(0) : "--";
        tr.appendChild(ecCell);

        const shsCell = document.createElement("td");
        shsCell.textContent = typeof row.shs !== "undefined" ? Number(row.shs).toFixed(1) : "--";
        tr.appendChild(shsCell);

        const stageCell = document.createElement("td");
        const stage = row.stage || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
        stageCell.innerHTML = '<span class="stage-chip">' + stage + "</span>";
        tr.appendChild(stageCell);

        const adviceCell = document.createElement("td");
        adviceCell.className = "advice-cell";
        adviceCell.textContent = row.advice || "â€”";
        tr.appendChild(adviceCell);

        tbody.appendChild(tr);
      });
    }

    function fillSummaryStats() {
      const statMoisture = document.getElementById("statMoisture");
      const statTemp = document.getElementById("statTemp");
      const statPh = document.getElementById("statPh");
      const statShs = document.getElementById("statShs");
      const statStage = document.getElementById("statStage");
      const statStageChip = document.getElementById("statStageChip");
      const historyMeta = document.getElementById("historyMeta");

      if (!historyData.length) {
        statMoisture.textContent = "-- Ùª";
        statTemp.textContent = "-- Â°Ù…";
        statPh.textContent = "--";
        statShs.textContent = "--";
        statStage.textContent = "--";
        statStageChip.textContent = "Ù…Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø¹Ø¯";
        historyMeta.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ø¨Ø¹Ø¯";
        return;
      }

      const last = historyData[0]; // Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø±ØªØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…

      statMoisture.textContent =
        typeof last.m !== "undefined" ? Number(last.m).toFixed(1) + " Ùª" : "-- Ùª";
      statTemp.textContent =
        typeof last.t !== "undefined" ? Number(last.t).toFixed(1) + " Â°Ù…" : "-- Â°Ù…";

      const phVals = historyData
        .map(r => r.ph)
        .filter(v => typeof v !== "undefined");
      const shsVals = historyData
        .map(r => r.shs)
        .filter(v => typeof v !== "undefined");

      const avg = arr => arr.reduce((s,v) => s+v,0) / (arr.length || 1);

      statPh.textContent = phVals.length ? avg(phVals).toFixed(2) : "--";
      statShs.textContent = shsVals.length ? avg(shsVals).toFixed(1) : "--";

      const stage = last.stage || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
      statStage.textContent = stage;
      statStageChip.textContent = stage;

      const fromTime = historyData[historyData.length - 1].timestamp;
      const toTime = last.timestamp;
      if (fromTime && toTime) {
        historyMeta.textContent =
          "Ø¢Ø®Ø± Ù¡Ù  Ù‚Ø±Ø§Ø¡Ø§Øª Ù…Ù† " + formatTimeLabel(fromTime) + " Ø¥Ù„Ù‰ " + formatTimeLabel(toTime);
      } else {
        historyMeta.textContent = "Ø¢Ø®Ø± Ù¡Ù  Ù‚Ø±Ø§Ø¡Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©";
      }
    }

    function createOrUpdateChart(id, label, labels, data, extra = {}) {
      const ctx = document.getElementById(id).getContext("2d");

      if (charts[id]) {
        charts[id].data.labels = labels;
        charts[id].data.datasets[0].data = data;
        charts[id].update();
        return;
      }

      charts[id] = new Chart(ctx, {
        type: extra.type || "line",
        data: {
          labels,
          datasets: [
            {
              label,
              data,
              tension: 0.3,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          },
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 5 } }
          }
        }
      });
    }

    function updateCharts() {
      if (!historyData.length) return;

      const labels = historyData.map(r =>
        r.timestamp ? formatTimeLabel(r.timestamp) : ""
      ).reverse(); // Ø§Ù„Ø£Ù‚Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø¹Ø±Ø¶

      const mArr = historyData.map(r => r.m ?? null).reverse();
      const tArr = historyData.map(r => r.t ?? null).reverse();
      const phArr = historyData.map(r => r.ph ?? null).reverse();
      const ecArr = historyData.map(r => r.ec ?? null).reverse();
      const shsArr = historyData.map(r => r.shs ?? null).reverse();

      createOrUpdateChart("chartMoisture", "Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø© Ùª", labels, mArr);
      createOrUpdateChart("chartTemp", "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Â°Ù…", labels, tArr);

      // pH Ùˆ EC Ù…Ø¹ Ø¨Ø¹Ø¶
      const ctxPhEc = document.getElementById("chartPhEc").getContext("2d");
      if (!charts["chartPhEc"]) {
        charts["chartPhEc"] = new Chart(ctxPhEc, {
          type: "line",
          data: {
            labels,
            datasets: [
              { label: "pH", data: phArr, tension: 0.3 },
              { label: "EC ÂµS/cm", data: ecArr, tension: 0.3 }
            ]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: {
              x: { ticks: { autoSkip: true, maxTicksLimit: 5 } }
            }
          }
        });
      } else {
        charts["chartPhEc"].data.labels = labels;
        charts["chartPhEc"].data.datasets[0].data = phArr;
        charts["chartPhEc"].data.datasets[1].data = ecArr;
        charts["chartPhEc"].update();
      }

      createOrUpdateChart("chartShs", "Ù…Ø¤Ø´Ø± ØµØ­Ø© Ø§Ù„ØªØ±Ø¨Ø© SHS", labels, shsArr);
    }

    async function loadHistory() {
      const historyMeta = document.getElementById("historyMeta");
      historyMeta.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";

      try {
        const res = await fetch(HISTORY_API_URL, { method: "GET" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        if (!Array.isArray(data) || !data.length) {
          historyData = [];
        } else {
          // Ù†ØªÙˆÙ‚Ø¹ Ø£Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙŠØ±Ø¬Ù‘Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
          historyData = data;
        }

        fillHistoryTable();
        fillSummaryStats();
        updateCharts();
      } catch (err) {
        console.error(err);
        historyMeta.textContent = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message;
      }
    }

    // ================== Ø´Ø§Øª Ø¨ÙˆØª Ù†ÙØ³Øº ==================
    const chatToggle = document.getElementById("chatToggle");
    const chatPanel = document.getElementById("chatPanel");
    const chatClose = document.getElementById("chatClose");
    const chatBody = document.getElementById("chatBody");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");
    const chatStatus = document.getElementById("chatStatus");

    let chatHistory = []; // [{role:"user"/"assistant", content:"..."}]

    function appendMessage(role, text) {
      const msg = document.createElement("div");
      msg.className = "msg " + (role === "user" ? "user" : "assistant");

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;

      const meta = document.createElement("div");
      meta.className = "msg-meta";
      meta.textContent = role === "user" ? "Ø£Ù†Øª" : "Ù†ÙØ³Øº AI";

      msg.appendChild(bubble);
      msg.appendChild(meta);
      chatBody.appendChild(msg);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    chatToggle.addEventListener("click", () => {
      chatPanel.style.display = chatPanel.style.display === "flex" ? "none" : "flex";
    });

    chatClose.addEventListener("click", () => {
      chatPanel.style.display = "none";
    });

    chatSend.addEventListener("click", sendChatMessage);
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendChatMessage();
      }
    });

    async function sendChatMessage() {
      const text = chatInput.value.trim();
      if (!text) return;

      appendMessage("user", text);
      chatHistory.push({ role: "user", content: text });
      chatInput.value = "";
      chatStatus.textContent = "Ù†Ø³Øº Ù‚Ø§Ø¹Ø¯ ÙŠÙÙƒØ± Ù„Ùƒ Ø¨Ø¬ÙˆØ§Ø¨ Ù…Ø±ØªØ¨... ğŸ˜‰";

      try {
        const payload = {
          message: text,
          history: chatHistory,
          style: "nasgh-ar-omani" // Ø¹Ø´Ø§Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙŠØ¶Ø¨Ø· Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø¨ØµÙŠØºØ© Ù†Ø³Øº
        };

        const res = await fetch(CHAT_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        const reply = data.reply || "Ø­ØµÙ„Øª Ù…Ø´ÙƒÙ„Ø© Ø¨Ø³ÙŠØ·Ø© ÙÙŠ Ø§Ù„Ø±Ø¯ØŒ Ø¬Ø±Ù‘Ø¨ ØªØ³Ø£Ù„ Ù…Ø±Ù‘Ø© Ø«Ø§Ù†ÙŠØ© Ù„Ùˆ Ø³Ù…Ø­Øª ğŸ™";

        // Ù†Ø¶ÙŠÙ Ø£Ø³Ù„ÙˆØ¨ Ù†Ø³Øº Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø±Ø¬Ù‘Ø¹ Ù†Øµ Ø¹Ø§Ù…
        const finalReply =
          reply +
          "\n\n(Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù† Ù†Ø³Øº ğŸŒ¿: Ù‡Ø°ÙŠ Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ø§Ù…Ø©ØŒ Ù„Ø§ ØªÙ†Ø³Ù ØªØ±Ø§Ø¬Ø¹ Ø¸Ø±ÙˆÙ Ù…Ø²Ø±Ø¹ØªÙƒ Ø¨Ø§Ù„Ø¶Ø¨Ø·ØŒ Ø§Ù„Ø¬ÙˆØŒ ÙˆÙ†ÙˆØ¹ Ø§Ù„ØªØ±Ø¨Ø© Ø¹Ù†Ø¯Ùƒ ÙÙŠ Ø¹Ù…Ø§Ù†)";

        appendMessage("assistant", finalReply);
        chatHistory.push({ role: "assistant", content: finalReply });
        chatStatus.textContent = "Ø¬Ø§Ù‡Ø² Ù„Ø³Ø¤Ø§Ù„ Ø«Ø§Ù†ÙŠ ğŸ˜„";
      } catch (err) {
        console.error(err);
        appendMessage("assistant", "ØµØ§Ø± Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ø¬Ø±Ù‘Ø¨ Ø¨Ø¹Ø¯ Ø´ÙˆÙŠØ© Ø£Ùˆ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù†Øª ğŸ™");
        chatStatus.textContent = "ØµØ§Ø± Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.";
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    loadHistory();
  </script>
</body>
</html>
